============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0
rootdir: C:\Users\Julien Fritsch\Documents\GitHub\MariaDB AI Demo Competition\backend
configfile: pytest.ini
plugins: anyio-4.10.0, Faker-39.0.0, langsmith-0.5.1, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 6 items

backend\tests\test_user_scenario.py F...FF                               [100%]

================================== FAILURES ===================================
________________ TestCyberMondayScenario.test_step_1_diagnosis ________________

self = <test_user_scenario.TestCyberMondayScenario object at 0x00000203A6B38CD0>

    def test_step_1_diagnosis(self):
        """
        Phase 1: Diagnosis & Cost Awareness
        Verify that analyzing the slow query returns high cost and risk.
        """
        response = client.post("/analysis/analyze", json={"sql": SLOW_QUERY})
>       assert response.status_code == 200
E       assert 404 == 200
E        +  where 404 = <Response [404 Not Found]>.status_code

backend\tests\test_user_scenario.py:53: AssertionError
_______________ TestCyberMondayScenario.test_step_5_simulation ________________

self = <test_user_scenario.TestCyberMondayScenario object at 0x00000203A6B0FD10>

    def test_step_5_simulation(self):
        """
        Phase 4: Validation (Traffic Simulator)
        Simulate load on the (hypothetical) optimized query
        """
        payload = {
            "query_pattern": "SELECT * FROM orders WHERE ...",
            "tps": 100,
            "duration_sec": 1,
            "type": "read_heavy"
        }
        response = client.post("/simulation/start", json=payload)
        assert response.status_code == 200
        data = response.json()
>       assert data["success"] is True
               ^^^^^^^^^^^^^^^
E       KeyError: 'success'

backend\tests\test_user_scenario.py:135: KeyError
_______________ TestCyberMondayScenario.test_step_6_deployment ________________

self = <test_user_scenario.TestCyberMondayScenario object at 0x00000203A6B1DAE0>

    def test_step_6_deployment(self):
        """
        Phase 5: Resolution (Deployment)
        Deploy the index change.
        """
        payload = {
            "sql": "ALTER TABLE orders ADD INDEX idx_user_created (user_id, created_at)",
            "target_env": "production",
            "deploy_strategy": "online_schema_change"
        }
        response = client.post("/deploy/production", json=payload)
        assert response.status_code == 200
        data = response.json()
    
        # Should succeed (mocked or real)
>       assert data["success"] is True
E       assert False is True

backend\tests\test_user_scenario.py:153: AssertionError
---------------------------- Captured stderr call -----------------------------
python: can't open file 'C:\\Users\\Julien Fritsch\\Documents\\GitHub\\MariaDB AI Demo Competition\\backend\\traffic_simulator.py': [Errno 2] No such file or directory

------------------------------ Captured log call ------------------------------
ERROR    routers.deploy:deploy.py:73 Deployment failed: Table 'shop_demo.orders' doesn't exist
=========================== short test summary info ===========================
FAILED backend\tests\test_user_scenario.py::TestCyberMondayScenario::test_step_1_diagnosis
FAILED backend\tests\test_user_scenario.py::TestCyberMondayScenario::test_step_5_simulation
FAILED backend\tests\test_user_scenario.py::TestCyberMondayScenario::test_step_6_deployment
======================== 3 failed, 3 passed in 23.85s =========================
