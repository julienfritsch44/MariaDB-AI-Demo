{"expand":"schema,names","startAt":0,"maxResults":10,"total":1350,"issues":[{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"137721","self":"https://jira.mariadb.org/rest/api/2/issue/137721","key":"MDEV-38164","fields":{"summary":"Poor cost calculations for index access cause bad query plans for big VARCHARs in 11.x","description":"This comes from customer case analysis in TODO-5687.\r\n\r\nConsider a table which defines a lot of long VARCHAR columns but the values are much smaller than the maximum length (this is fairly common):\r\n{code:sql}\r\ncreate table t1 (\r\n  pk1 int not null,\r\n  pk2 int not null,\r\n  filler1 varchar(500),\r\n  filler2 varchar(500),\r\n  filler3 varchar(500),\r\n  filler4 varchar(500),\r\n  filler5 varchar(500),\r\n  filler6 varchar(500),\r\n  filler7 varchar(500),\r\n  filler8 varchar(500),\r\n  filler9 varchar(500),\r\n  fillerA varchar(500),\r\n  fillerB varchar(500),\r\n  fillerC varchar(500),\r\n  fillerD varchar(500),\r\n  fillerE varchar(500),\r\n  fillerF varchar(500),\r\n  primary key(pk1, pk2)\r\n) collate utf8mb4_general_ci engine=innodb;\r\n\r\ninsert into t1 (pk1, pk2) select\r\n  mod(seq, 8), seq\r\nfrom\r\n  seq_1_to_10000;\r\nanalyze table t1;\r\n{code}\r\n\r\nThe table has 10K rows, let's use a condition on PK prefix to select 12.5% of that:\r\n\r\n{code}\r\nexplain select * from t1 where pk1=1;\r\n{code}\r\n\r\nSurprisingly, this will pick full table scan:\r\n\r\n{code}\r\nid      select_type     table   type    possible_keys   key     key_len ref     rows    Extra\r\n1       SIMPLE  t1      ALL     PRIMARY NULL    NULL    NULL    10000   Using where\r\n{code}\r\n\r\nOptimizer trace will show that \r\n* estimated record numbers are OK for both access methods \r\n* estimated cost of full scan is OK\r\n* estimated cost for RANGE is very high:\r\n{code:json}\r\n                \"range_analysis\": {\r\n                  \"table_scan\": {\r\n                    \"rows\": 10000,\r\n                    \"cost\": 1.6673536\r\n                  },\r\n                  \"potential_range_indexes\": [\r\n                    {\r\n                      \"index\": \"PRIMARY\",\r\n                      \"usable\": true,\r\n                      \"key_parts\": [\"pk1\", \"pk2\"]\r\n                    }\r\n                  ],\r\n                  \"setup_range_conditions\": [],\r\n                  \"analyzing_range_alternatives\": {\r\n                    \"range_scan_alternatives\": [\r\n                      {\r\n                        \"index\": \"PRIMARY\",\r\n                        \"ranges\": [\"(1) <= (pk1) <= (1)\"],\r\n                        \"rowid_ordered\": true,\r\n                        \"using_mrr\": false,\r\n                        \"index_only\": false,\r\n                        \"rows\": 1250,\r\n                        \"cost\": 2.82014029,\r\n                        \"chosen\": false,\r\n                        \"cause\": \"cost\"\r\n                      }\r\n                    ],\r\n{code}\r\n\r\nThe reason for this is that the cost of range access over clustered PK is computed as cost of reading N index tuples of {{TABLE_SHARE::stored_rec_length}} size. This number is a worst-case upper-bound estimate.  It is very far from reality in this case.\r\n\r\nThe cost  of full table scan is computed using {{handler->stats.data_file_length}} estimate, which does account for values being much smaller than their maximum possible size.\r\n","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/317990","id":"317990","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"{code}\r\ncommit 94e86ec5d0ee95e94af0a249ee9c5037b861caed (HEAD -> bb-11.4-mdev-38164, origin/bb-11.4-mdev-38164, bb-11.4-todo-5687)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Fri Nov 21 13:17:19 2025 +0200\r\n\r\n    MDEV-38164: Fix the estimates reported by TABLE::key_storage_length()\r\n    \r\n    They were based on the maximum possible key tuple length, which can be\r\n    much larger than the real data size.\r\n    \r\n    The return value is used by handler::keyread_time(), which is used\r\n    to estimate the cost of range access.\r\n    This could cause range access not to be picked, even if it uses\r\n    the clustered PK and reads about 8% of the table.\r\n    \r\n    The fix is to add KEY::stat_storage_length (next to KEY::rec_per_key) and\r\n    have the storage engine fill it in handler::info(HA_STATUS_CONST).\r\n    \r\n    Currently, only InnoDB fills this based on its internal statistics:\r\n    index->stat_index_size and ib_table->stat_n_rows.\r\n    \r\n    Also changed:\r\n    - In handler::calculate_costs(), use ha_keyread_clustered_time() when\r\n      computing clustered PK read cost, not ha_keyread_time().\r\n    \r\n    The fix is OFF by default and enabled by setting FIX_INDEX_LOOKUP_COST flag\r\n    in @@new_mode.\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-25T08:56:31.000+0000","updated":"2025-11-25T08:56:31.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318004","id":"318004","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Got Monty's review (pass 2) for this one. There are a few inputs to address.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-25T10:16:06.000+0000","updated":"2025-11-25T10:16:06.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318117","id":"318117","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Getting this failure on when the fix is globally enabled:\r\n{code}\r\n--- /optane/dev-git2/12.2-mdev-38164/mysql-test/main/order_by_optimizer_innodb.result   2025-11-24 14:07:50.125255016 +0200\r\n+++ /optane/dev-git2/12.2-mdev-38164/mysql-test/main/order_by_optimizer_innodb.reject   2025-11-26 14:57:17.278181912 +0200\r\n@@ -46,7 +46,7 @@\r\n # This also must use range, not ref. key_len must be 13\r\n EXPLAIN SELECT * FROM t2                       WHERE pk1=9 AND fd5 < 500 ORDER BY fd5 DESC LIMIT 10;\r\n id     select_type     table   type    possible_keys   key     key_len ref     rows    Extra\r\n-1      SIMPLE  t2      range   PRIMARY,ux_pk1_fd5      ux_pk1_fd5      13      NULL    138     Using index condition\r\n+1      SIMPLE  t2      range   PRIMARY,ux_pk1_fd5      ux_pk1_fd5      13      NULL    138     Using where\r\n drop table t2;\r\n #\r\n # MDEV-6814: Server crashes in calculate_key_len on query with ORDER BY\r\n\r\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-26T12:57:56.000+0000","updated":"2025-11-26T12:57:56.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318121","id":"318121","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Ok, \"Using index condition\" is not used due to this reason:\r\n\r\nThe indexes are:\r\n{code}\r\n PRIMARY KEY (pk1,pk2), \r\n UNIQUE KEY ux_pk1_fd5 (pk1,fd5) \r\n{code}\r\n\r\nThe query is:\r\n{code}\r\n... WHERE pk1=9 AND fd5 < 500 ORDER BY fd5 DESC LIMIT 10;\r\n{code}\r\n\r\nAfter the fix, we have this:\r\n- The range and join optimizers pick range (and ref(const)) over pk1=9.\r\n- test_if_skip_sort_order() finds that ux_pk1_fd5 matches the ORDER BY LIMIT\r\n  and switches to that.\r\n- But it doesn't do Index Condition Pushdown on the index.\r\n\r\n\r\nAdditionally, before the fix I observe this behavior:\r\n\r\n- range/join optimzier pick the range access over ux_pk1_fd5\r\n- attached_conditions_computation calls the join optimizer again(!)\r\n   but this just adds CPU overhead, we still pick ux_pk1_fd5 again.\r\n- Index Condition Pushdown is performed.\r\n\r\n\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-26T13:12:38.000+0000","updated":"2025-11-26T13:12:38.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318314","id":"318314","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Another  observation about the above query:\r\nAfter the patch, the optimizer produces \"cost\": 0.15856389 for\r\n{code}\r\n index: \"PRIMARY\", rows=722,   \"ranges\": [\"(9) <= (pk1) <= (9)\"],\r\n{code}\r\nand higher \"cost\": 0.21899416 for:\r\n{code}\r\n\"index\": \"ux_pk1_fd5\",  \"rows\": 138,  \"ranges\": [\"(9,NULL) < (pk1,fd5) < (9,500)\"]\r\n{code}\r\n\r\ntrace:\r\n{code:js}\r\n \"range_scan_alternatives\": [\r\n   {\r\n      \"index\": \"PRIMARY\",\r\n      \"ranges\": [\"(9) <= (pk1) <= (9)\"],\r\n      \"rowid_ordered\": true,\r\n      \"using_mrr\": false,\r\n      \"index_only\": false,\r\n      \"rows\": 722,\r\n      \"cost\": 0.15856389,\r\n      \"chosen\": true\r\n    },\r\n    {\r\n      \"index\": \"ux_pk1_fd5\",\r\n      \"ranges\": [\"(9,NULL) < (pk1,fd5) < (9,500)\"],\r\n      \"rowid_ordered\": false,\r\n      \"using_mrr\": false,\r\n      \"index_only\": false,\r\n      \"rows\": 138,\r\n      \"cost\": 0.21899416,\r\n      \"chosen\": false,\r\n      \"cause\": \"cost\"\r\n    }\r\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-28T16:17:53.000+0000","updated":"2025-12-01T11:54:59.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318318","id":"318318","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"How so?  Investigating where the cost numbers came from...\r\n\r\nh2. For index=PRIMARY\r\n\r\nin handler::multi_range_read_info_const(),handler::calculate_costs():\r\n\r\nin handler::keyread_time()\r\n{code}\r\n  rows=723\r\n  table->key_storage_length(index)=778\r\n  table->key_storage_length_from_ddl(index)=1617\r\n\r\n  // number of stats.block_size=16K blocks to read from index\r\n  blocks=46\r\n  io_blocks=184 // number of IO_SIZE=4K blocks\r\n{code}\r\n\r\nback in handler::calculate_costs():\r\n{code}\r\n  index_blocks(keyno) = 520 \r\n{code}\r\nThe cost we get is\r\n{code}\r\n *cost = { \r\n    avg_io_cost = 0.00020480000000000002,\r\n    cpu_cost = 0,\r\n    comp_cost = 0.023104,\r\n    copy_cost = 0.043948139999999997,\r\n    limit_cost = 0,\r\n    setup_cost = 0.00079111999999999997,\r\n    index_cost = {\r\n      io = 184, \r\n      cpu = 0.053037429999999997\r\n    }, \r\n    row_cost = { io = 0,  cpu = 0 }\r\n  }\r\n{code}\r\n\r\nh2. For index=ux_pk1_fd5 (pk1,fd5)\r\n\r\nin handler::multi_range_read_info_const(),handler::calculate_costs():\r\nin handler::keyread_time()\r\n{code}\r\n  rows=139\r\n  table->key_storage_length(index)=21\r\n  table->key_storage_length_from_ddl(index)=21\r\n\r\n  blocks=1      // in stats.block_size=16K blocks\r\n  io_blocks= 4  // in IO_SIZE=4K blocks\r\n{code}\r\n\r\nin handler::ha_rnd_pos_time(rows=138) :\r\n\r\n{code:cpp}\r\n  virtual IO_AND_CPU_COST rnd_pos_time(ha_rows rows)\r\n  {\r\n    double r= rows2double(rows);\r\n    return\r\n    {\r\n      r * ((stats.block_size + IO_SIZE -1 )/IO_SIZE),  // Blocks read\r\n      r * INDEX_BLOCK_COPY_COST                        // Copy block from cache\r\n     };\r\n{code}\r\n\r\nThat is, we return that we will read\r\n{code}\r\n 138 * 16K / 4K = 552 blocks.\r\n{code}\r\n\r\nThen in handler::ha_rnd_pos_time():\r\n \r\n{code:cpp}\r\n  inline IO_AND_CPU_COST ha_rnd_pos_time(ha_rows rows)\r\n  {\r\n    IO_AND_CPU_COST cost= rnd_pos_time(rows);\r\n    set_if_smaller(cost.io, (double) row_blocks());\r\n    cost.cpu+= rows2double(rows) * (ROW_LOOKUP_COST + ROW_COPY_COST);\r\n    return cost;\r\n  }\r\n{code}\r\nSo we've got cost.io=552. \r\nThat's higher than reading the whole table! The set_if_smaller clips it to the value of:\r\n{code}\r\nrow_blocks()=388\r\n{code}\r\n\r\nThe final cost value we get is:\r\n{code}\r\n(gdb) p *cost\r\n  $119 = {\r\n    avg_io_cost = 0.00020480000000000002, \r\n    cpu_cost = 0, \r\n    comp_cost = 0.0044159999999999998,\r\n    copy_cost = 0,\r\n    limit_cost = 0,  \r\n    setup_cost = 0,\r\n    index_cost = {\r\n      io = 4,\r\n      cpu = 0.014488719999999998\r\n    }, \r\n    row_cost = {\r\n      io = 388, \r\n      cpu = 0.11901671999999999\r\n    } \r\n  }\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-28T16:48:16.000+0000","updated":"2025-11-28T16:48:16.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318348","id":"318348","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Summarizing the above:\r\n|cost component|PRIMARY|ux_pk1_fd5|\r\n|index_cost.io|0.0376832|0.0008192|\r\n|index_cost.cpu|0.05303743|0.01448872|\r\n|row_cost.io|0|0.0794624|\r\n|row_cost.cpu|0|0.11901672|\r\n|copy_cost|0.04394814|0|\r\n|comp_cost|0.023104|0.004416|\r\n|cpu_cost|0|0|\r\n|setup_cost|0.00079112|0.00079112|\r\n|TOTAL|0.15856389|0.21899416|\r\n\r\nFractions of cost in ux_pk1_fd5 :\r\n|cost component|FK_IDX|COST_PERCENT|\r\n|index_cost.io|0.0008192|0.37|\r\n|index_cost.cpu|0.01448872|6.62|\r\n|row_cost.io|0.0794624|36.29| <<< |\r\n|row_cost.cpu|0.11901672|54.35| <<< |\r\n|copy_cost|0|0.00|\r\n|comp_cost|0.004416|2.02|\r\n|cpu_cost|0|0.00|\r\n|setup_cost|0.00079112|0.36|\r\n|TOTAL|0.21899416|100|\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-01T07:18:57.000+0000","updated":"2025-12-01T07:19:24.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318352","id":"318352","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Note: this commit has added '#ifdef NOT_USED':\r\n\r\n{code}\r\ncommit b66cdbd1eaeed7e96317a03a190c496fd062ec71\r\nAuthor:\tMonty <monty@mariadb.org>  Thu Aug 11 13:05:23 2022\r\nCommitter:\tSergei Petrunia <sergey@mariadb.com>  Thu Feb  2 22:54:45 2023\r\n{code}\r\n\r\nin storage/innobase/handler/ha_innodb.cc:\r\n\r\n{code:cpp}\r\n#ifdef NOT_USED\r\ndouble\r\nha_innobase::read_time(\r\n\r\n/*===================*/\r\n        uint    index,  /*!< in: key number */\r\n        uint    ranges, /*!< in: how many ranges */\r\n        ha_rows rows)   /*!< in: estimated number of rows in the ranges */\r\n{       \r\n        ha_rows total_rows;\r\n...\r\n{code}\r\n\r\nThat's why handler::rnd_pos_time is used.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-01T07:45:12.000+0000","updated":"2025-12-01T07:47:59.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318355","id":"318355","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"\r\nLooking at cost calculations again:\r\n\r\n{code:cpp}\r\n  virtual IO_AND_CPU_COST rnd_pos_time(ha_rows rows)\r\n  {\r\n    double r= rows2double(rows);\r\n    return\r\n    {\r\n      r * ((stats.block_size + IO_SIZE -1 )/IO_SIZE),  // Blocks read\r\n      r * INDEX_BLOCK_COPY_COST                        // Copy block from cache\r\n     };\r\n  }\r\n{code}\r\n\r\nThis assumes that for each row we will do a stats.block_size read.\r\nFor InnoDB, (stats.block_size/IO_SIZE)=4.\r\nWe read 4 IO_SIZE blocks for each row.\r\nrows=138,  blocks=552.\r\n\r\n{code:cpp}\r\n  inline IO_AND_CPU_COST ha_rnd_pos_time(ha_rows rows)\r\n  {\r\n    IO_AND_CPU_COST cost= rnd_pos_time(rows);\r\n    set_if_smaller(cost.io, (double) row_blocks());\r\n    cost.cpu+= rows2double(rows) * (ROW_LOOKUP_COST + ROW_COPY_COST);\r\n    return cost;\r\n  }\r\n{code}\r\n\r\nHowever, row_blocks()=388, so we clip cost.io.\r\n\r\nQuestions:\r\n  - Should we use \"select without replacement\" formula?\r\n  - Should we clip cost.cpu also?\r\n\r\nBut the biggest of all is that we know that restrictions on \r\nPK limit the PK values to about one third of the table:\r\n{code}\r\n rows=723 / (stats.records=2041) = 0.35\r\n{code}\r\n\r\nand since this index has PK as a prefix, we will only get row ids\r\nin this range. \r\nSo instead of clipping by row_blocks(), we should clip by  0.35 * row_blocks().\r\n(In case of select-without-replacement formula, pass this reduced range as\r\na parameter).","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-01T08:30:39.000+0000","updated":"2025-12-01T08:30:39.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318366","id":"318366","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Note that *THE OLD CODE* in multi_range_read.cc:get_sweep_read_cost()  used \"select with replacement\" formula:\r\n\r\n{code:cpp}\r\n      double n_blocks=\r\n        ceil(ulonglong2double(table->file->stats.data_file_length) / IO_SIZE);\r\n      double busy_blocks=\r\n        n_blocks * (1.0 - pow(1.0 - 1.0/n_blocks, rows2double(nrows)));\r\n      if (busy_blocks < 1.0)\r\n        busy_blocks= 1.0;\r\n{code}\r\n\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-01T08:50:49.000+0000","updated":"2025-12-01T08:50:49.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318401","id":"318401","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Investigation of this last testcase is continued in MDEV-38231","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-01T13:05:12.000+0000","updated":"2025-12-01T13:05:12.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318524","id":"318524","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Pushed the fix \r\n* into 11.4  (disabled by default, can be enabled via {{@@NEW_MODE}} variable) \r\n* into 12.2 (enabled, no way to turn off)\r\n\r\n{code}\r\ncommit 4cff562f3f89d4df03e09233d835d0451bc37cc4 (HEAD -> 11.4, origin/bb-11.4-mdev-38164, origin/11.4, bb-11.4-mdev-38164)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Fri Nov 21 13:17:19 2025 +0200\r\n\r\n    MDEV-38164: Fix the estimates reported by TABLE::key_storage_length()\r\n    \r\n    They were based on the maximum possible key tuple length, which can be\r\n    much larger than the real data size.\r\n    \r\n    The return value is used by handler::keyread_time(), which is used\r\n    to estimate the cost of range access.\r\n    This could cause range access not to be picked, even if it uses\r\n    the clustered PK and reads about 8% of the table.\r\n    \r\n    The fix is to add KEY::stat_storage_length (next to KEY::rec_per_key) and\r\n    have the storage engine fill it in handler::info(HA_STATUS_CONST).\r\n    \r\n    Currently, only InnoDB fills this based on its internal statistics:\r\n    index->stat_index_size and ib_table->stat_n_rows.\r\n    \r\n    Also changed:\r\n    - In handler::calculate_costs(), use ha_keyread_clustered_time() when\r\n      computing clustered PK read cost, not ha_keyread_time().\r\n    \r\n    The fix is OFF by default and enabled by setting FIX_INDEX_LOOKUP_COST flag\r\n    in @@new_mode.\r\n{code}\r\n\r\n{code}\r\ncommit 8647354f6b36e019c1d768e682f26f0754aa8fef (HEAD -> 12.2, origin/bb-12.2-mdev38164, origin/12.2, bb-12.2-mdev38164)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Fri Nov 21 13:17:19 2025 +0200\r\n\r\n    MDEV-38164: Fix the estimates reported by TABLE::key_storage_length()\r\n    \r\n    (Cherry-pick into 12.2: the fix is enabled by default,\r\n     control via @@new_mode=FIX_INDEX_LOOKUP_COST is removed)\r\n...\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-02T16:24:46.000+0000","updated":"2025-12-02T16:24:46.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137721/comment/318565","id":"318565","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Problem description:\r\n\r\n*Short*:\r\nThe bug can be observed with tables that define very long variable-length (typically VARCHAR) columns, while actual table data has values that are much shorter\r\nthan maximum length.\r\n\r\nFor those tables, the optimizer produces poor query plans: range and index lookups accesses are considered to be much more expensive than they really are. The optimizer may pick a full table scan which is obviously slower than index-based access.\r\n\r\n*More details*:\r\nMariaDB has introduced new cost model in 11.0.\r\nCost of index-based access is now a complex formula which includes the cost to read index pages. The number of index pages is estimated as \r\n{code}\r\n  number_of_index_records_to_read * index_record_size\r\n{code}\r\n\r\nThe problem is that {{index_record_size}} value was \"maximum possible value length\", not an average record length . This caused big (e.g. 30x) overestimates in case of variable-length columns and short values.\r\n\r\nOn the other hand, the cost of full table scan was computed based on the number of disk pages occupied by the table rows. That is, it used real record sizes and wasn't overestimated. As a consequence, the optimizer would prefer full table scan when range or index lookup were clearly better.\r\n\r\n*The fix*\r\nThe fix is to compute {{index_record_size}} based on the real number of pages in the index. \r\nThis way, we don't get the over-estimates.\r\n\r\nIn MariaDB before 12.2, the fix is not enabled by default due to plan stability concerns. \r\nSet  {{@@new_mode}} variable (or my.cnf parameter) to include FIX_INDEX_LOOKUP_COST.\r\n\r\nIn MariaDB 12.2 (not yet stable), the fix is always enabled and no switch is provided.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-12-03T09:23:03.000+0000","updated":"2025-12-03T09:30:50.000+0000"}],"maxResults":13,"total":13,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"137312","self":"https://jira.mariadb.org/rest/api/2/issue/137312","key":"MDEV-38003","fields":{"summary":"Intermittent Replication Failure on a multi-table DELETE ","description":"I upgraded from 11.4.x last week.  After an overnight batch process, I got a replication failure on several tables.  I determined the cause was a single, multi-table DELETE that cleans up some old rows.  \r\n\r\nThe statement works fine on the MASTER but does not replicate to the SLAVE.  It doesn't even appear in the MASTER's binlog and so never even gets sent to the SLAVE I don't think.  I use MIXED replication.  Here's the kicker.  The second time I run the statement, when there are 0 rows to delete on the MASTER, then the statement is logged and replicated and the SLAVE gets back into sync.  This HAS TO BE A REGRESSION.\r\n\r\nThis is a routine function that has run nightly for over 10 years and never caused a single problem until I upgraded to 11.8.  I can get nothing from the error logs about it.  It issues no warnings when I try SHOW WARNINGS.  I even enabled performance_schema logging and this is the result:\r\n\r\n              THREAD_ID: 2152574\r\n               EVENT_ID: 6\r\n           END_EVENT_ID: 6\r\n             EVENT_NAME: statement/sql/delete_multi\r\n                 SOURCE: \r\n            TIMER_START: 384545772677685000\r\n              TIMER_END: 384545783917225000\r\n             TIMER_WAIT: 11239540000\r\n              LOCK_TIME: 157000000\r\n               SQL_TEXT: DELETE pc, pcru, cl, cs\r\n                  FROM pc \r\n                  LEFT JOIN pcru ON pcru.pc_id=pc.pc_id\r\n                  LEFT JOIN cl ON cl.pc_id=pc.pc_id\r\n                  LEFT JOIN cs ON cs.pc_id=pc.pc_id\r\n                  WHERE pc.ru_id='262' \r\n                  AND pc.time<'2025-08-31 00:00:00'\r\n                 DIGEST: a5fae46dc7cf0c4a2b40c1cc8d78260d\r\n         CURRENT_SCHEMA: production\r\n            OBJECT_TYPE: NULL\r\n          OBJECT_SCHEMA: NULL\r\n            OBJECT_NAME: NULL\r\n  OBJECT_INSTANCE_BEGIN: NULL\r\n            MYSQL_ERRNO: 0\r\n      RETURNED_SQLSTATE: 00000\r\n           MESSAGE_TEXT: NULL\r\n                 ERRORS: 0\r\n               WARNINGS: 0\r\n          ROWS_AFFECTED: 144\r\n              ROWS_SENT: 0\r\n          ROWS_EXAMINED: 1710\r\nCREATED_TMP_DISK_TABLES: 0\r\n     CREATED_TMP_TABLES: 4\r\n       SELECT_FULL_JOIN: 0\r\n SELECT_FULL_RANGE_JOIN: 0\r\n           SELECT_RANGE: 0\r\n     SELECT_RANGE_CHECK: 0\r\n            SELECT_SCAN: 0\r\n      SORT_MERGE_PASSES: 0\r\n             SORT_RANGE: 0\r\n              SORT_ROWS: 0\r\n              SORT_SCAN: 0\r\n          NO_INDEX_USED: 0\r\n     NO_GOOD_INDEX_USED: 0\r\n       NESTING_EVENT_ID: NULL\r\n     NESTING_EVENT_TYPE: NULL\r\n    NESTING_EVENT_LEVEL: 0\r\n\r\nSo this shows ROWS AFFECTED: 144 -- this is the first time.  The rows are successfully deleted on the MASTER without any issue but nothing happens on the SLAVE. Here is what it looks like the 2nd time the command is issued and where the SLAVE does delete its rows and \"catches up\" to the MASTER:\r\n\r\n             THREAD_ID: 2157652\r\n               EVENT_ID: 6\r\n           END_EVENT_ID: 6\r\n             EVENT_NAME: statement/sql/delete_multi\r\n                 SOURCE: \r\n            TIMER_START: 386046338379228000\r\n              TIMER_END: 386046344241938000\r\n             TIMER_WAIT: 5862710000\r\n              LOCK_TIME: 163000000\r\n               SQL_TEXT: DELETE pc, pcru, cl, cs\r\n                  FROM pc \r\n                  LEFT JOIN pcru ON pcru.pc_id=pc.pc_id\r\n                  LEFT JOIN cl ON cl.pc_id=pc.pc_id\r\n                  LEFT JOIN cs ON cs.pc_id=pc.pc_id\r\n                  WHERE pc.ru_id='262' \r\n                  AND pc.time<'2025-08-31 00:00:00'\r\n                 DIGEST: a5fae46dc7cf0c4a2b40c1cc8d78260d\r\n         CURRENT_SCHEMA: production\r\n            OBJECT_TYPE: NULL\r\n          OBJECT_SCHEMA: NULL\r\n            OBJECT_NAME: NULL\r\n  OBJECT_INSTANCE_BEGIN: NULL\r\n            MYSQL_ERRNO: 0\r\n      RETURNED_SQLSTATE: 00000\r\n           MESSAGE_TEXT: NULL\r\n                 ERRORS: 0\r\n               WARNINGS: 0\r\n          ROWS_AFFECTED: 0\r\n              ROWS_SENT: 0\r\n          ROWS_EXAMINED: 1447\r\nCREATED_TMP_DISK_TABLES: 0\r\n     CREATED_TMP_TABLES: 4\r\n       SELECT_FULL_JOIN: 0\r\n SELECT_FULL_RANGE_JOIN: 0\r\n           SELECT_RANGE: 0\r\n     SELECT_RANGE_CHECK: 0\r\n            SELECT_SCAN: 0\r\n      SORT_MERGE_PASSES: 0\r\n             SORT_RANGE: 0\r\n              SORT_ROWS: 0\r\n              SORT_SCAN: 0\r\n          NO_INDEX_USED: 0\r\n     NO_GOOD_INDEX_USED: 0\r\n       NESTING_EVENT_ID: NULL\r\n     NESTING_EVENT_TYPE: NULL\r\n    NESTING_EVENT_LEVEL: 0\r\n\r\nNotice the 2nd time it says ROWS AFFECTED: 0 .  That is the only clue I have in this entire, miserable experience. \r\n\r\nAll tables are innodb. It's not a complicated query.  It uses the pc table's PRIMARY KEY, which contains an INDEXED column in all the subordinate tables. The DELETE takes miliseconds to perform. It has run everyday for over 10 years without ever causing a single issue -- until I upgraded to 11.8 . \r\n\r\nI don't see how the query could be considered non-deterministic for replication, and as I said already, I'm using MIXED mode, so if a \"STATEMENT\" were considered bad, it SHOULD switch to ROW based replication.  If nothing else, it should issue warnings or log something to the error log (I set log_warnings to 3), and yet nothing.  \r\n\r\nThere are any number of workarounds. Right now I just run the DELETE statement twice in a row.   But beyond the inexplicable mystery of this, I have to be concerned that other queries will fall prey to this same regression.   I use multi-table DELETES throughout several code bases. Fortunately none of the others are triggering this bug. ","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316440","id":"316440","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"body":"I tried switching from MIXED format to ROW and STATEMENT.  The error is identical under all three binlog_format settings.\r\n\r\nI also tried removing 2 of the 3 LEFT JOINs.  The issue goes away then, but that is obviously not a satisfactory solution.  2 LEFT JOINS (3 table DELETE) had the same problems as 3 LEFT JOINS (4 table DELETE).\r\n\r\nWhen I changed to STATEMENT format, I saw errors in the log about unsafe binlog statements.  These were other queries though, and despite the errors, they replicated just fine with no ill effects. \r\n\r\nI also failed over to the slave and replicated to the master to see if the problem persisted. It DOES.  \r\n\r\nThese are not particularly large deletes -- 24 rows per day in the pc table with expansion to in the range of 100-200 rows with the 3 subordinate tables joined in.  At most we're talking about 2-3MB of data, but I don't even think it's that large.  I can't see any config byte values I could raise that would alleviate this regression.\r\n\r\nThe fact that this query doesn't replicate, with no errors or warnings, is very unacceptable.  It should either fail to run on the master and there should be explicitly defined constraints about multi-table deleting, or it should simply work as it always has for the past 10+ years without any issues. ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"created":"2025-11-01T23:13:18.000+0000","updated":"2025-11-01T23:13:18.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316550","id":"316550","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bnestere","name":"bnestere","key":"JIRAUSER48702","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Brandon Nesterenko","active":true,"timeZone":"America/Denver"},"body":"Hi [~susil.behera]! This looks to be a new regression, can you try to reproduce it?\r\n\r\n[~Elkin], [~knielsen], [~serg] FYI","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bnestere","name":"bnestere","key":"JIRAUSER48702","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Brandon Nesterenko","active":true,"timeZone":"America/Denver"},"created":"2025-11-03T13:51:34.000+0000","updated":"2025-11-03T13:51:34.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316565","id":"316565","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bnestere","name":"bnestere","key":"JIRAUSER48702","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Brandon Nesterenko","active":true,"timeZone":"America/Denver"},"body":"Status update is that [~Gosselin] changed some things in multi-table delete in {{11.8}} and is taking a look to see if it is related to this report. ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bnestere","name":"bnestere","key":"JIRAUSER48702","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Brandon Nesterenko","active":true,"timeZone":"America/Denver"},"created":"2025-11-03T16:14:36.000+0000","updated":"2025-11-03T16:14:36.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316593","id":"316593","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"Hello [~herrnoel],\r\nI can see the misbehaving query in the performance_schema logging that you sent.  Additionally, please send the following information:\r\n# Table definitions related to the problem query (e.g. SHOW CREATE TABLE).  No sample data required.\r\n# The result of the following query on the master:  SHOW VARIABLES LIKE '%binlog%';\r\n# The result of the following query on the master:  SHOW VARIABLES LIKE '%repl%';\r\n# The result of the following query on the master:  EXPLAIN EXTENDED DELETE pc, pcru, cl, cs FROM pc LEFT JOIN pcru ON pcru.pc_id=pc.pc_id LEFT JOIN cl ON cl.pc_id=pc.pc_id LEFT JOIN cs ON cs.pc_id=pc.pc_id WHERE pc.ru_id='262' AND pc.time<'2025-08-31 00:00:00';\r\n# The result of the following query on the master:  ANALYZE format=json DELETE pc, pcru, cl, cs FROM pc LEFT JOIN pcru ON pcru.pc_id=pc.pc_id LEFT JOIN cl ON cl.pc_id=pc.pc_id LEFT JOIN cs ON cs.pc_id=pc.pc_id WHERE pc.ru_id='262' AND pc.time<'2025-08-31 00:00:00';\r\n\r\nLocal reproduction in a replicated environment with three tables LEFT JOIN'd together isn't showing a problem.  I will continue to experiment but I need this information to shortcut the process.  Thanks in advance.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-03T20:24:54.000+0000","updated":"2025-11-03T20:25:09.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316651","id":"316651","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"EXPLAIN EXTENDED produces a Note message which echoes back the query (sometimes permuted by optimizations) to the client and is included in the output of SHOW WARNINGS but it is not indicative of a problem with your query.  Please see the SHOW WARNINGS [documentation page|https://mariadb.com/docs/server/reference/sql-statements/administrative-sql-statements/show/show-warnings] for details.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-04T13:13:06.000+0000","updated":"2025-11-04T13:13:06.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316676","id":"316676","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"h3. Reproduction Scenario\r\nThe following scenario reproduces the observed behavior on 11.8.3 under MIXED mode (but not ROW mode, details on that later in this post):\r\n{code:sql}\r\ndrop table if exists t1, t2, t3;\r\ncreate table t1 (pk int, num int);\r\ncreate table t2 (pk int, num int);\r\ncreate table t3 (pk int, num int);\r\ninsert into t1 (pk, num) values (1,1900),(2,1901);\r\ninsert into t2 (pk, num) values (2,2001),(2,2002);\r\ninsert into t3 (pk, num) values (1,40),(2,42);\r\n\r\nselect * from t1 left join t2 on t1.pk = t2.pk left join t3 on t2.pk = t3.pk;\r\nselect * from t1 left join t2 on t1.pk = t2.pk left join t3 on t2.pk = t3.pk where t2.num <= 2002;\r\ndelete t1, t2, t3 from t1 left join t2 on t1.pk = t2.pk left join t3 on t2.pk = t3.pk where t2.num <= 2002;\r\nselect * from t1 left join t2 on t1.pk = t2.pk left join t3 on t2.pk = t3.pk;\r\n{code}\r\n\r\nh3. Synopsis\r\nWhen deleting from multiple tables, the DELETE operator uses a temporary table to collect the row IDs of rows that will be deleted.  If this table grows too large, then we convert it from a heap temporary table to a persistent (on-disk) temporary table to avoid unbounded memory usage.  There are several error codes that gate creating this persistent temporary table but themselves don't indicate a problem with the DELETE operation.  However, regardless of this error code value, we need to clear it after deciding whether or not to create the persistent temporary table.  If we don't clear this value, then the error code's stale state prevents binlog replication.\r\n\r\nh3. Technical Details\r\nTesting is ongoing but the following appears to be the correct follow up to fix this issue (pending a review).  More concretely, we need to apply this diff:\r\n{code}\r\ndiff --git a/sql/sql_delete.cc b/sql/sql_delete.cc\r\nindex 347cb4ccabb..9f012c0898a 100644\r\n--- a/sql/sql_delete.cc\r\n+++ b/sql/sql_delete.cc\r\n@@ -1474,6 +1474,7 @@ int multi_delete::send_data(List<Item> &values)\r\n               }\r\n               found++;\r\n           }\r\n+          error= 0;\r\n       }\r\n     }\r\n   }\r\n{code}\r\nso that {{error}} here in sql_delete.cc does not retain stale state that is then muxed into {{local_error}}:\r\n{code:c++}\r\n 1733   /* Does deletes for the last n - 1 tables, returns 0 if ok */\r\n 1734   int local_error= do_deletes();                // returns 0 if success\r\n 1735\r\n 1736   /* compute a total error to know if something failed */\r\n 1737   local_error= local_error || error;\r\n{code}\r\nOnly a few lines later in the same function can we see that a nonzero {{local_error}} will prevent the binlog from being written:\r\n{code:c++}\r\n 1762   if (likely((local_error == 0) ||\r\n 1763              thd->transaction->stmt.modified_non_trans_table) ||\r\n 1764       thd->log_current_statement())\r\n 1765   { \r\n 1766        ... // binlog written from this point\r\n{code}\r\nRegarding the different {{binlog_format}} values, I was not able to reproduce this failure under ROW, only STATEMENT and MIXED.  That's because we have this code in the table handler logic, which is called from the DELETE operator via {{TABLE::delete_row}} (such as in {{multi_delete::send_data}} and {{multi_delete::rowid_table_deletes}}):\r\n{code:c++}\r\n 7672 int handler::binlog_log_row(const uchar *before_record,\r\n 7673                             const uchar *after_record,\r\n 7674                             Log_func *log_func)\r\n 7675 {\r\n 7676   DBUG_ENTER(func_: \"handler::binlog_log_row\");\r\n 7677\r\n 7678   int error = 0;\r\n 7679   if (row_logging)\r\n 7680     error= binlog_log_row_to_binlog(table, before_record, after_record,\r\n 7681                                     log_func, has_trans: row_logging_has_trans);\r\n ...\r\n{code}\r\nYou can see here that {{row_logging}} must be true for this codepath to execute and indeed that's the case when binlog_format=ROW.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-04T18:33:17.000+0000","updated":"2025-11-04T18:33:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316677","id":"316677","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"body":"This doesn't align with my experience.\r\n\r\nFrom Performance Schema (initial post)\r\n\r\nCREATED_TMP_DISK_TABLES: 0\r\nCREATED_TMP_TABLES: 4\r\n\r\nNo on disk tables were created. I find it hard to believe that disk was used when the DELETE completes instantly.\r\n\r\nAnd when I tried to switch to ROW based logging, I got the same exact behavior.  I used SET GLOBAL though, I didn't change the config and restart the db. ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"created":"2025-11-04T18:49:17.000+0000","updated":"2025-11-04T18:49:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316683","id":"316683","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"The logic to check whether the temporary table needs to be created executes, regardless of whether the temporary table is created or not.  In the reproduction case I supplied, no peristent temporary tables were created.  But as I said before, \"There are several error codes that gate creating this persistent temporary table but themselves don't indicate a problem with the DELETE operation.\"  That state needs to be cleared after the check is done, in any case.\r\n\r\nI set the binlog_format in the server configuration file and restarted both servers each time.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-04T22:11:17.000+0000","updated":"2025-11-04T22:11:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316684","id":"316684","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"body":"Thank you for the clarification with regards to temp tables.\r\n\r\nCan the binlog_format be changed in a client session if the user has the right privileges? Because I changed it to ROW and confirmed with a SHOW GLOBAL VARIABLES.... statement.  But the DELETE still failed the first time when there were actually rows to remove and succeeded the second time when there were not.  ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=herrnoel","name":"herrnoel","key":"JIRAUSER51763","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17313","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17313","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17313","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17313"},"displayName":"Eric X","active":true,"timeZone":"Etc/UTC"},"created":"2025-11-04T23:17:25.000+0000","updated":"2025-11-04T23:17:25.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/316761","id":"316761","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"There are some important considerations when changing the binary log format on a replicated pair, please see [this documentation|https://mariadb.com/docs/server/server-management/server-monitoring-logs/binary-log/binary-log-formats#configuring-the-binary-log-format] (\"Configuring the Binary Log Format\") for details.  To avoid pitfalls in a replicated setup, I only change the binary format via the configuration file and restart the servers.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-05T13:52:20.000+0000","updated":"2025-11-05T13:52:20.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137312/comment/318107","id":"318107","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=sanja","name":"sanja","key":"sanja","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=sanja&avatarId=22112","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=sanja&avatarId=22112","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=sanja&avatarId=22112","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=sanja&avatarId=22112"},"displayName":"Oleksandr Byelkin","active":true,"timeZone":"Europe/Berlin"},"body":"OK to push","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=sanja","name":"sanja","key":"sanja","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=sanja&avatarId=22112","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=sanja&avatarId=22112","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=sanja&avatarId=22112","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=sanja&avatarId=22112"},"displayName":"Oleksandr Byelkin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-11-26T11:28:26.000+0000","updated":"2025-11-26T11:28:26.000+0000"}],"maxResults":11,"total":11,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"137136","self":"https://jira.mariadb.org/rest/api/2/issue/137136","key":"MDEV-37913","fields":{"summary":"disable_index_merge_plans causes SELECT data loss when more than 100 ORs","description":"Major regression introduced with index_merge optimization causes SELECT to lose data when used more than 100 OR conditions. See complete SQL in attachment. \r\n\r\n{code:sql}\r\nCREATE TABLE `index_merge_test` (\r\n  `id` int(11) NOT NULL AUTO_INCREMENT,\r\n  `uniq2` smallint(6) NOT NULL DEFAULT 0,\r\n  PRIMARY KEY (`id`),\r\n  KEY `uniq2` (`uniq2`)\r\n) ENGINE=MyISAM;\r\n\r\nINSERT INTO `index_merge_test` (`id`, `uniq2`) VALUES\r\n\t(1, 1),\r\n\t(2, 1),\r\n\t(3, 2);\r\n{code}\r\n\r\n\r\n{code:sql}\r\nSELECT id FROM index_merge_test WHERE\r\n -- (uniq2 = 2 AND id = 3) OR /* Try to uncomment this line. Expected number of results: 3. Returned number results: 1.  */\r\n  (uniq2 = 1)\r\n OR (uniq2 = 1)\r\n OR (uniq2 = 1)\r\n OR (uniq2 = 1)\r\n-- (repeat 100x)\r\n{code}\r\n","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/137136/comment/315986","id":"315986","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Draft PR: https://github.com/MariaDB/server/pull/4402 . \r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-24T19:14:49.000+0000","updated":"2025-10-24T19:14:49.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137136/comment/316163","id":"316163","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Updated the PR. New fix variant is simpler.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-28T14:11:59.000+0000","updated":"2025-10-28T14:11:59.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137136/comment/316187","id":"316187","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"OK to push.\r\n\r\nVerified that new return codepath is executed by new test case.\r\nVerified that the tests from related MDEV-34620 pass and exercise the new return codepath.\r\nVerified that the test fails without the fix because the prior logic could force tree1's key map to be empty incorrectly.\r\nChecked code coverage results.\r\nRan complete regression suite.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-10-28T22:04:27.000+0000","updated":"2025-10-28T22:04:27.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137136/comment/316194","id":"316194","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=mariadb-pavithrapandith","name":"mariadb-pavithrapandith","key":"JIRAUSER56652","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Pavithra Pandith","active":true,"timeZone":"Etc/UTC"},"body":"Testing done:\r\nAble to reproduce the issue on 10.11\r\nVerified issue is fixed with patch ( i.e on 10.11-mdev-37913 branch)\r\nTried with both atomic and complex conditions in 100 OR clause\r\nDone crash testing and result correctness using rqg ,no issues found ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=mariadb-pavithrapandith","name":"mariadb-pavithrapandith","key":"JIRAUSER56652","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Pavithra Pandith","active":true,"timeZone":"Etc/UTC"},"created":"2025-10-29T06:35:58.000+0000","updated":"2025-10-29T06:35:58.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137136/comment/316420","id":"316420","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Monty doesn't have any objections to the patch","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-31T15:43:20.000+0000","updated":"2025-10-31T15:43:20.000+0000"}],"maxResults":5,"total":5,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"137117","self":"https://jira.mariadb.org/rest/api/2/issue/137117","key":"MDEV-37901","fields":{"summary":"Wrong result with Loose Scan on QUICK_GROUP_MIN_MAX_SELECT WITH TIES","description":"Query with QUICK_GROUP_MIN_MAX + ORDER BY WITH TIES\r\nproduced wrong result, as QUICK_GROUP_MIN_MAX doesn't support\r\nORDERING operation with it. However, ORDERING was done as part of\r\nGROUP BY operation.\r\n\r\nThank you [~psergei]  for the test case. It is below in the comment.","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/137117/comment/315584","id":"315584","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"This seems  to imply that one cannot construct a testcase just for this bug.\r\nFor the example provided, the unmodified server will produce a plan with \"Using filesort\"   and correct query result. \r\n\r\nHere is an example that will fail on the unmodified server:\r\n\r\n{code:sql}\r\ncreate table t1 (\r\n  country varchar(100),\r\n  city varchar(100),\r\n  user_score int,\r\n  index (country, city, user_score)\r\n);\r\n\r\ninsert into t1 \r\nselect 'China', 'Shenzhen', seq from seq_10_to_100;\r\ninsert into t1 \r\nselect 'India', 'New Delhi', seq from seq_10_to_100;\r\ninsert into t1 \r\nselect 'Sri Lanka', 'Colombo', seq from seq_10_to_100;\r\nanalyze table t1 persistent for all;\r\n\r\ninsert into t1 \r\nselect 'Finland', 'Espoo', seq from seq_10_to_200;\r\ninsert into t1 \r\nselect 'Greece', 'Chania', seq from seq_10_to_20;\r\ninsert into t1 \r\nselect 'Estonia', 'Narva', seq from seq_10_to_20;\r\ninsert into t1 \r\nselect 'Russia', 'St Petersburg', seq from seq_10_to_20;\r\n{code}\r\n\r\n{code:sql}\r\nexplain\r\nselect country, city, min(user_score)\r\nfrom t1\r\nwhere user_score between 9 and 199\r\ngroup by country, city\r\norder by country\r\nfetch first 5 rows with ties;\r\n{code}\r\n\r\nwill produce:\r\n{code}\r\n+------+-------------+-------+-------+---------------+---------+---------+------+------+---------------------------------------+\r\n| id   | select_type | table | type  | possible_keys | key     | key_len | ref  | rows | Extra                                 |\r\n+------+-------------+-------+-------+---------------+---------+---------+------+------+---------------------------------------+\r\n|    1 | SIMPLE      | t1    | range | NULL          | country | 211     | NULL | 4    | Using where; Using index for group-by |\r\n+------+-------------+-------+-------+---------------+---------+---------+------+------+---------------------------------------+\r\n1 row in set (0.001 sec)\r\n{code}\r\nand the SELECT itself:\r\n{code}\r\n+-----------+---------------+-----------------+\r\n| country   | city          | min(user_score) |\r\n+-----------+---------------+-----------------+\r\n| China     | Shenzhen      |              10 |\r\n| Estonia   | Narva         |              10 |\r\n| Finland   | Espoo         |              10 |\r\n| Greece    | Chania        |              10 |\r\n| India     | New Delhi     |              10 |\r\n| Russia    | St Petersburg |              10 |\r\n| Sri Lanka | Colombo       |              10 |\r\n+-----------+---------------+-----------------+\r\n7 rows in set (0.001 sec)\r\n{code}\r\n\r\nwhile\r\n{code:sql}\r\nselect country, city, min(user_score)\r\nfrom t1 use index()\r\nwhere user_score between 9 and 199\r\ngroup by country, city\r\norder by country\r\nfetch first 5 rows with ties;\r\n{code}\r\nwill produce\r\n{code}\r\n+---------+-----------+-----------------+\r\n| country | city      | min(user_score) |\r\n+---------+-----------+-----------------+\r\n| China   | Shenzhen  |              10 |\r\n| Estonia | Narva     |              10 |\r\n| Finland | Espoo     |              10 |\r\n| Greece  | Chania    |              10 |\r\n| India   | New Delhi |              10 |\r\n+---------+-----------+-----------------+\r\n5 rows in set (0.007 sec)\r\n{code}\r\n\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-21T08:58:43.000+0000","updated":"2025-10-21T08:58:43.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/137117/comment/315681","id":"315681","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"body":"PR for this is here: https://github.com/MariaDB/server/pull/4391","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"created":"2025-10-22T04:23:20.000+0000","updated":"2025-10-22T04:23:20.000+0000"}],"maxResults":2,"total":2,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"136797","self":"https://jira.mariadb.org/rest/api/2/issue/136797","key":"MDEV-37774","fields":{"summary":"ASAN: use-after-poison in Gap_time_tracker::log_time","description":"https://buildbot.mariadb.org/#/builders/1031/builds/372/steps/12/logs/stdio\r\n\r\nSetup:\r\n- Ensure clang is used for build\r\n- Invoke cmake to include -DWITH_ASAN_SCOPE=ON -DWITH_UBSAN=ON -DWITH_ASAN=ON\r\n- Before starting MariaDB:  export UBSAN_OPTIONS=print_stacktrace=1:report_error_type=1\r\n\r\n\r\n{code:java}\r\nmain.log_slow_innodb                     w14 [ fail ]\r\n        Test ended at 2025-09-22 06:55:26\r\nCURRENT_TEST: main.log_slow_innodb\r\nmysqltest: At line 58: query 'SELECT 1' failed: <Unknown> (2013): Lost connection to server during query\r\nThe result from queries just before the failure was:\r\n< snip >\r\n[log_grep.inc] found expected match count: 3\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Query_time: \\d+\\.\\d+  Lock_time: \\d+\\.\\d+  Rows_sent: \\d+  Rows_examined: \\d+$ expected_matches: 3\r\n[log_grep.inc] found expected match count: 3\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Rows_affected: \\d+  Bytes_sent: \\d+$ expected_matches: 3\r\n[log_grep.inc] found expected match count: 3\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Full_scan: (Yes|No)  Full_join: (Yes|No)  Tmp_table: (Yes|No)  Tmp_table_on_disk: (Yes|No)$\r\n[log_grep.inc] lines:   1\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Filesort: (Yes|No)  Filesort_on_disk: (Yes|No)  Merge_passes: \\d+\\ Priority_queue: (Yes|No)$\r\n[log_grep.inc] lines:   0\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Filesort: (Yes|No)  Filesort_on_disk: (Yes|No)  Merge_passes: \\d+\\ Priority_queue: (Yes|No)$\r\n[log_grep.inc] lines:   0\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Tmp_tables: \\d+  Tmp_disk_tables: \\d+$\r\n[log_grep.inc] lines:   0\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Pages_accessed: \\d+  Pages_read: \\d+  Pages_prefetched: \\d+  Pages_updated: \\d+  Old_rows_read: \\d+$ expected_matches: 2\r\n[log_grep.inc] found expected match count: 2\r\n[log_grep.inc] file: log_slow_innodb-verbosity_1 pattern: ^# Pages_read_time: \\d+\\.\\d+  Engine_time: \\d+\\.\\d+$ expected_matches: 2\r\n[log_grep.inc] found expected match count: 2\r\nSET SESSION log_slow_verbosity='innodb,query_plan';\r\n[slow_log_start.inc] log_slow_innodb-verbosity_2\r\nSELECT 1;\r\nMore results from queries before failure can be found in /dev/shm/normal/14/log/log_slow_innodb.log\r\nServer [mysqld.1 - pid: 259736, winpid: 259736, exit: 256] failed during test run\r\nServer log from this test:\r\n----------SERVER LOG START-----------\r\n=================================================================\r\n==259739==ERROR: AddressSanitizer: use-after-poison on address 0x7dcfd5efa038 at pc 0x55ba235bd2ea bp 0x7affb2264250 sp 0x7affb2264248\r\nREAD of size 8 at 0x7dcfd5efa038 thread T15\r\n    #0 0x55ba235bd2e9 in Gap_time_tracker::log_time(unsigned long long, unsigned long long) /home/buildbot/src/sql/sql_analyze_stmt.h:147:12\r\n    #1 0x55ba235bd2e9 in process_gap_time_tracker(THD*, unsigned long long) /home/buildbot/src/sql/sql_analyze_stmt.cc:117:36\r\n    #2 0x55ba23598e61 in Exec_time_tracker::start_tracking(THD*) /home/buildbot/src/sql/sql_analyze_stmt.h:102:5\r\n    #3 0x55ba23598e61 in Explain_query::Explain_query(THD*, st_mem_root*) /home/buildbot/src/sql/sql_explain.cc:51:29\r\n    #4 0x55ba235b96a0 in create_explain_query(LEX*, st_mem_root*) /home/buildbot/src/sql/sql_explain.cc:2767:32\r\n    #5 0x55ba2304ef76 in JOIN::prepare(TABLE_LIST*, Item*, unsigned int, st_order*, bool, st_order*, Item*, st_order*, st_select_lex*, st_select_lex_unit*) /home/buildbot/src/sql/sql_select.cc:1437:7\r\n    #6 0x55ba230448c0 in mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*) /home/buildbot/src/sql/sql_select.cc:5218:21\r\n    #7 0x55ba23043653 in handle_select(THD*, LEX*, select_result*, unsigned long long) /home/buildbot/src/sql/sql_select.cc:600:10\r\n    #8 0x55ba22f444dc in execute_sqlcom_select(THD*, TABLE_LIST*) /home/buildbot/src/sql/sql_parse.cc:6427:12\r\n    #9 0x55ba22f25af5 in mysql_execute_command(THD*, bool) /home/buildbot/src/sql/sql_parse.cc:4008:12\r\n    #10 0x55ba22f091d5 in mysql_parse(THD*, char*, unsigned int, Parser_state*) /home/buildbot/src/sql/sql_parse.cc:8180:18\r\n    #11 0x55ba22f001ca in dispatch_command(enum_server_command, THD*, char*, unsigned int, bool) /home/buildbot/src/sql/sql_parse.cc:1906:7\r\n    #12 0x55ba22f0b765 in do_command(THD*, bool) /home/buildbot/src/sql/sql_parse.cc:1419:17\r\n    #13 0x55ba234fd8dc in do_handle_one_connection(CONNECT*, bool) /home/buildbot/src/sql/sql_connect.cc:1475:11\r\n    #14 0x55ba234fd119 in handle_one_connection /home/buildbot/src/sql/sql_connect.cc:1387:5\r\n    #15 0x55ba246635bc in pfs_spawn_thread /home/buildbot/src/storage/perfschema/pfs.cc:2201:3\r\n    #16 0x55ba229ac086 in asan_thread_start(void*) asan_interceptors.cpp.o\r\n    #17 0x7effd0fb01f4  (/lib/x86_64-linux-gnu/libc.so.6+0x891f4) (BuildId: 79005c16293efa45b441fed45f4f29b138557e9e)\r\n    #18 0x7effd102faff in clone (/lib/x86_64-linux-gnu/libc.so.6+0x108aff) (BuildId: 79005c16293efa45b441fed45f4f29b138557e9e)\r\n0x7dcfd5efa038 is located 7224 bytes inside of 32760-byte region [0x7dcfd5ef8400,0x7dcfd5f003f8)\r\nallocated by thread T15 here:\r\n    #0 0x55ba229ae704 in malloc (/home/buildbot/bld/sql/mariadbd+0x1dd5704) (BuildId: 04e51ea346864e85564787eabec4169bae30e338)\r\n    #1 0x55ba251cf778 in my_malloc /home/buildbot/src/mysys/my_malloc.c:92:29\r\n    #2 0x55ba251ae6e9 in reset_root_defaults /home/buildbot/src/mysys/my_alloc.c:247:30\r\n    #3 0x55ba22d26ce0 in THD::init_for_queries() /home/buildbot/src/sql/sql_class.cc:1473:3\r\n    #4 0x55ba234fc1b3 in prepare_new_connection_state(THD*) /home/buildbot/src/sql/sql_connect.cc:1314:8\r\n    #5 0x55ba234fe26e in thd_prepare_connection(THD*) /home/buildbot/src/sql/sql_connect.cc:1408:3\r\n    #6 0x55ba234fd8bc in do_handle_one_connection(CONNECT*, bool) /home/buildbot/src/sql/sql_connect.cc:1465:9\r\n    #7 0x55ba234fd119 in handle_one_connection /home/buildbot/src/sql/sql_connect.cc:1387:5\r\n    #8 0x55ba246635bc in pfs_spawn_thread /home/buildbot/src/storage/perfschema/pfs.cc:2201:3\r\n    #9 0x55ba229ac086 in asan_thread_start(void*) asan_interceptors.cpp.o\r\nThread T15 created by T0 here:\r\n    #0 0x55ba22992931 in pthread_create (/home/buildbot/bld/sql/mariadbd+0x1db9931) (BuildId: 04e51ea346864e85564787eabec4169bae30e338)\r\n    #1 0x55ba2466391c in my_thread_create(unsigned long*, pthread_attr_t const*, void* (*)(void*), void*) /home/buildbot/src/storage/perfschema/my_thread.h:52:10\r\n    #2 0x55ba2466391c in pfs_spawn_thread_v1 /home/buildbot/src/storage/perfschema/pfs.cc:2252:15\r\n    #3 0x55ba22a076a2 in inline_mysql_thread_create(unsigned int, unsigned long*, pthread_attr_t const*, void* (*)(void*), void*) /home/buildbot/src/include/mysql/psi/mysql_thread.h:1139:11\r\n    #4 0x55ba22a076a2 in create_thread_to_handle_connection(CONNECT*) /home/buildbot/src/sql/mysqld.cc:6139:19\r\n    #5 0x55ba22a08cb8 in handle_connections_sockets() /home/buildbot/src/sql/mysqld.cc:6383:9\r\n    #6 0x55ba22a06e22 in run_main_loop() /home/buildbot/src/sql/mysqld.cc:5639:3\r\n    #7 0x55ba229fc2d7 in mysqld_main(int, char**) /home/buildbot/src/sql/mysqld.cc:6040:3\r\n    #8 0x7effd0f4e249  (/lib/x86_64-linux-gnu/libc.so.6+0x27249) (BuildId: 79005c16293efa45b441fed45f4f29b138557e9e)\r\nSUMMARY: AddressSanitizer: use-after-poison /home/buildbot/src/sql/sql_analyze_stmt.h:147:12 in Gap_time_tracker::log_time(unsigned long long, unsigned long long)\r\nShadow bytes around the buggy address:\r\n  0x7dcfd5ef9d80: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5ef9e00: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5ef9e80: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5ef9f00: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5ef9f80: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n=>0x7dcfd5efa000: f7 f7 f7 f7 f7 f7 f7[f7]f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5efa080: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5efa100: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5efa180: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5efa200: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\n  0x7dcfd5efa280: f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7 f7\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==259739==ABORTING\r\n250922  6:55:23 [ERROR] /home/buildbot/bld/sql/mariadbd got signal 6 ;\r\nSorry, we probably made a mistake, and this is a bug.\r\nYour assistance in bug reporting will enable us to fix this for the next release.\r\nTo report this bug, see https://mariadb.com/kb/en/reporting-bugs about how to report\r\na bug on https://jira.mariadb.org/.\r\nPlease include the information from the server start above, to the end of the\r\ninformation below.\r\nServer version: 10.11.15-MariaDB-asan-log source revision: 573d3ad1c61a14f72483e756da38be5b105169d3\r\nThe information page at https://mariadb.com/kb/en/how-to-produce-a-full-stack-trace-for-mariadbd/\r\ncontains instructions to obtain a better version of the backtrace below.\r\nFollowing these instructions will help MariaDB developers provide a fix quicker.\r\nAttempting backtrace. Include this in the bug report.\r\n(note: Retrieving this information may fail)\r\nThread pointer: 0x7dafd03d3218\r\nstack_bottom = 0x7affb2266000 thread_stack 0xb00000\r\n/home/buildbot/bld/sql/mariadbd(___interceptor_backtrace+0x46)[0x55ba22954486]\r\nmysys/stacktrace.c:215(my_print_stacktrace)[0x55ba251dd815]\r\nsql/signal_handler.cc:0(handle_fatal_signal)[0x55ba23b2f018]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x3c050)[0x7effd0f63050]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x8aeec)[0x7effd0fb1eec]\r\n/lib/x86_64-linux-gnu/libc.so.6(gsignal+0x12)[0x7effd0f62fb2]\r\n/lib/x86_64-linux-gnu/libc.so.6(abort+0xd3)[0x7effd0f4d472]\r\n/home/buildbot/bld/sql/mariadbd(+0x1dfddcc)[0x55ba229d6dcc]\r\n/home/buildbot/bld/sql/mariadbd(+0x1dfbc6e)[0x55ba229d4c6e]\r\n/home/buildbot/bld/sql/mariadbd(+0x1ddb729)[0x55ba229b4729]\r\n/home/buildbot/bld/sql/mariadbd(+0x1ddec57)[0x55ba229b7c57]\r\n/home/buildbot/bld/sql/mariadbd(__asan_report_load8+0x36)[0x55ba229b8b56]\r\n/home/buildbot/bld/sql/mariadbd(+0x29e42ea)[0x55ba235bd2ea]\r\nsql/sql_explain.cc:52(Explain_query::Explain_query(THD*, st_mem_root*))[0x55ba23598e62]\r\nsql/sql_explain.cc:2767(create_explain_query(LEX*, st_mem_root*))[0x55ba235b96a1]\r\nsql/sql_select.cc:0(JOIN::prepare(TABLE_LIST*, Item*, unsigned int, st_order*, bool, st_order*, Item*, st_order*, st_select_lex*, st_select_lex_unit*))[0x55ba2304ef77]\r\nsql/sql_select.cc:5218(mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*))[0x55ba230448c1]\r\nsql/sql_select.cc:600(handle_select(THD*, LEX*, select_result*, unsigned long long))[0x55ba23043654]\r\nsql/sql_parse.cc:0(execute_sqlcom_select(THD*, TABLE_LIST*))[0x55ba22f444dd]\r\nsql/sql_parse.cc:0(mysql_execute_command(THD*, bool))[0x55ba22f25af6]\r\nsql/sql_parse.cc:0(mysql_parse(THD*, char*, unsigned int, Parser_state*))[0x55ba22f091d6]\r\nsql/sql_parse.cc:0(dispatch_command(enum_server_command, THD*, char*, unsigned int, bool))[0x55ba22f001cb]\r\nsql/sql_parse.cc:1421(do_command(THD*, bool))[0x55ba22f0b766]\r\nsql/sql_connect.cc:1475(do_handle_one_connection(CONNECT*, bool))[0x55ba234fd8dd]\r\nsql/sql_connect.cc:1391(handle_one_connection)[0x55ba234fd11a]\r\nperfschema/pfs.cc:2203(pfs_spawn_thread)[0x55ba246635bd]\r\nasan_interceptors.cpp.o:0(asan_thread_start(void*))[0x55ba229ac087]\r\n/lib/x86_64-linux-gnu/libc.so.6(+0x891f5)[0x7effd0fb01f5]\r\n/lib/x86_64-linux-gnu/libc.so.6(__clone+0x40)[0x7effd102fb00]\r\n\r\n{code}\r\n","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/136797/comment/314083","id":"314083","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"body":"THD class has an instance of Gap_time_tracker_data, which has a reference to \"Gap_time_tracker\" using \"bill_to\" field. This bill_to field is set and reset using \r\n\r\n{code:java}\r\nvoid attach_gap_time_tracker(THD *thd, Gap_time_tracker *gap_tracker,\r\n                             ulonglong timeval)\r\n{\r\n  thd->gap_tracker_data.bill_to= gap_tracker;\r\n  thd->gap_tracker_data.start_time= timeval;\r\n}\r\n\r\nvoid process_gap_time_tracker(THD *thd, ulonglong timeval)\r\n{\r\n  if (thd->gap_tracker_data.bill_to)\r\n  {\r\n    thd->gap_tracker_data.bill_to->log_time(thd->gap_tracker_data.start_time,\r\n                                            timeval);\r\n    thd->gap_tracker_data.bill_to= NULL;\r\n  }\r\n}\r\n{code}\r\n\r\nAfter setting the bill_to, process_gap_time_tracker() is invoked when ever we want to start and stop tracking the time using Exec_time_tracker::start_tracking(), and Exec_time_tracker::stop_tracking()\r\n\r\nFrom the stack trace reported in the description, we see that Exec_time_tracker::start_tracking() is invoked during the Explain_Query instantiation. However, the previous instance of bill_to is not cleared although it was cleaned, and hence use_after_poison error is thrown.\r\n\r\nDuring clean_up_after_query, we could reset the bill_to field to NULL.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"created":"2025-10-01T09:20:44.000+0000","updated":"2025-10-01T09:33:28.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136797/comment/314085","id":"314085","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"body":"Gap_time_tracker_data::init() which resets the bill_to field to NULL, is already invoked in THD::init(). However, THD::init() is used during user change, but not after every single query.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=bsrikanth","name":"bsrikanth","key":"JIRAUSER56221","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17320","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17320","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17320","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17320"},"displayName":"Srikanth Bondalapati","active":true,"timeZone":"Asia/Kolkata"},"created":"2025-10-01T09:34:57.000+0000","updated":"2025-10-01T09:34:57.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136797/comment/314290","id":"314290","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"THe patch looks good to me, too.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-03T07:17:16.000+0000","updated":"2025-10-03T07:17:16.000+0000"}],"maxResults":3,"total":3,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"136714","self":"https://jira.mariadb.org/rest/api/2/issue/136714","key":"MDEV-37723","fields":{"summary":"TPROC-H, no stats: Query4 much slower in 11.4 than in 10.11","description":"{code:sql}\r\nselect o_orderpriority, count(*) as order_count\r\nfrom ORDERS\r\nwhere\r\n  o_orderdate >= date '1993-06-01'\r\n  and o_orderdate < date '1993-06-01' + interval '3' month\r\n  and exists\r\n  (\r\n    select * from LINEITEM \r\n    where l_orderkey = o_orderkey and l_commitdate < l_receiptdate\r\n  )\r\ngroup by o_orderpriority\r\norder by o_orderpriority;\r\n{code}\r\n\r\n10.11 uses First Match:\r\n{code}\r\nquery_id\tid\tselect_type\ttable\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tr_rows\tfiltered\tr_filtered\tExtra\r\nq4\t1\tPRIMARY\tORDERS\tALL\tPRIMARY\tNULL\tNULL\tNULL\t1469276\t1500000.00\t100\t3.82\tUsing where; Using temporary; Using filesort\r\nq4\t1\tPRIMARY\tLINEITEM\tref\tPRIMARY,IDX_LINEITEM_ORDERKEY_FKIDX\tPRIMARY\t8\ttpch.ORDERS.O_ORDERKEY\t1\t1.45\t100\t63.43\tUsing where; FirstMatch(ORDERS)\r\n{code}\r\n\r\n11.4 uses Materialization:\r\n{code}\r\nquery_id\tid\tselect_type\ttable\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tr_rows\tfiltered\tr_filtered\tExtra\r\nq4\t1\tPRIMARY\tORDERS\tALL\tPRIMARY\tNULL\tNULL\tNULL\t1465728\t1500000.00\t100\t3.82\tUsing where; Using temporary; Using filesort\r\nq4\t1\tPRIMARY\t<subquery2>\teq_ref\tdistinct_key\tdistinct_key\t8\tfunc\t1\t0.92\t100\t100\t\r\nq4\t2\tMATERIALIZED\tLINEITEM\tALL\tPRIMARY,IDX_LINEITEM_ORDERKEY_FKIDX\tNULL\tNULL\tNULL\t5982557\t5992551.00\t100\t63.22\tUsing where\r\n{code}","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313668","id":"313668","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"body":"h4. q4 analysis\r\n\r\n{code:sql}\r\nselect o_orderpriority, count(*) as order_count\r\n  from ORDERS\r\n  where o_orderdate >= date '1993-06-01'\r\n    and o_orderdate < date '1993-06-01' + interval '3' month\r\n    and exists\r\n    (\r\n      select * from LINEITEM where l_orderkey = o_orderkey and l_commitdate < l_receiptdate\r\n    )\r\n  group by o_orderpriority\r\n  order by o_orderpriority;\r\n{code}\r\n\r\n{noformat}\r\n        10.11\r\n                    \"plan_prefix\": [\"ORDERS\"],\\\r\n                    \"table\": \"LINEITEM\",\\\r\n                    \"rows_for_plan\": 3000000,\\\r\n                    \"cost_for_plan\": 2422105.968,\\\r\n                    \"semijoin_strategy_choice\": [\\\r\n                      {\\\r\n                        \"strategy\": \"FirstMatch\",\\\r\n                        \"records\": 1500000,\\\r\n                        \"read_time\": 2,422,105.968\\\r\n                      },\\\r\n                      {\\\r\n                        \"strategy\": \"SJ-Materialization\",\\\r\n                        \"records\": 1500000,\\\r\n                        \"read_time\": 7,814,451\\\r\n                      },\\\r\n\r\n        11.4\r\n\r\n                    \"plan_prefix\": \"ORDERS\",\\\r\n                    \"table\": \"LINEITEM\",\\\r\n                    \"rows_for_plan\": 4500000,\\\r\n                    \"cost_for_plan\": 2478.930274,\\\r\n                    \"semijoin_strategy_choice\": [\\\r\n                      {\\\r\n                        \"strategy\": \"FirstMatch\",\\\r\n                        \"rows\": 1500000,\\\r\n                        \"cost\": 2,478.930274\\\r\n                      },\\\r\n                      {\\\r\n                        \"strategy\": \"SJ-Materialization\",\\\r\n                        \"rows\": 1500000,\\\r\n                        \"cost\": 1,849.507542\\\r\n                      },\\\r\n{noformat}\r\n        \r\n        need to figure out what is going into these costs.\r\n\r\n        SJ-Materialization looks most wrong on 11.4\r\n\r\n        10.11  opt_subselect.cc:3139\r\n\r\n{noformat}\r\n(gdb) p mat_read_time\r\n$7 = 7814451\r\n(gdb) p prefix_cost \r\n$8 = 312464\r\n(gdb) p mat_info->materialization_cost.total_cost()\r\n$9 = 6001987\r\n(gdb) p prefix_rec_count\r\n$10 = 1500000\r\n(gdb) p mat_info->lookup_cost.total_cost()\r\n$11 = 1\r\n(gdb) p 312464 + 6001987 + 1500000 * 1\r\n$12 = 7814451\r\n{noformat}\r\n\r\n        11.4   opt_subselect.cc:3242\r\n\r\n{noformat}\r\n(gdb) p prefix_cost \r\n$6 = 255.16422719999997\r\n(gdb) p mat_info->materialization_cost\r\n$7 = 1441.9710051734598\r\n(gdb) p prefix_rec_count\r\n$8 = 1500000\r\n(gdb) p mat_info->lookup_cost\r\n$9 = 0.00010158154000000001\r\n(gdb) p 255.16422719999997 + mat_info->materialization_cost + prefix_rec_count * mat_info->lookup_cost\r\n$10 = 1849.5075423734597\r\n{noformat}\r\n\r\n\r\nratio of costs \r\nprefix_cost = 312464 / 255 = *1225*  ballpark expected for rows to ms conversion\r\nmaterialization_cost = 6001987 / 1441.971 = *4162*  seems high\r\nlookup cost  = 1 /  0.000101 = *9900*  an order of magnitude higher than expected.  \r\n\r\nGuessing that lookup_cost on 11.4 is under estimated.\r\n\r\n{code:c++}\r\n     2675         /* When reading a row, we have also to check the where clause */  \r\n  >  2676         sjm->lookup_cost= cost.lookup + WHERE_COST_THD(thd);\r\n{code}\r\n\r\n{noformat}\r\n(gdb) p cost.lookup\r\n$14 = 6.9581540000000007e-05\r\n(gdb) p WHERE_COST_THD(thd)\r\n$15 = 3.1999999999999999e-05\r\n{noformat}\r\n\r\nlatter is defined as ((THD)->variables.optimizer_where_cost)\r\nformer calculated as\r\n\r\n{code:c++}\r\n  >  2782     cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *    \r\n     2783                             tmp_table_optimizer_costs.disk_read_ratio) +            \r\n     2784                            row_copy_cost);     \r\n{code}\r\n\r\nthis is where row_count > thd->variables.max_heap_table_size / row_size\r\n\r\nif it was a HEAP TEMPTABLE (smaller row_count), cost.lookup would be 0.000163\r\n\r\ndisk read is 10 times slower.\r\n\r\nSo this is likely where the calculation has gone wrong.\r\n\r\n\r\ntmp_table_optimizer_costs.key_lookup_cost is 0.0004\r\nHEAP_TEMPTABLE_LOOKUP_COST                is 0.00016\r\n\r\nis it really only going to be 3x faster to read something from memory\r\nthen when we factor in the 0.02 disk read ratio we get the tmp table lookup cost\r\nbeing 0.000008, which is MUCH faster than HEAP temptable.\r\n\r\n*Baseline execution times*\r\n\r\n10.11 debug build\r\n\r\n{code:sql}\r\nMariaDB [tpch]> select o_orderpriority, count(*) as order_count from ORDERS where o_orderdate >= date '1993-06-01' and o_orderdate < date '1993-06-01' + interval '3' month and exists ( select * from LINEITEM where l_orderkey = o_orderkey and l_commitdate < l_receiptdate) group by o_orderpriority order by o_orderpriority;\r\n+-----------------+-------------+\r\n| o_orderpriority | order_count |\r\n+-----------------+-------------+\r\n| 1-URGENT        |       10540 |\r\n| 2-HIGH          |       10754 |\r\n| 3-MEDIUM        |       10435 |\r\n| 4-NOT SPECIFIED |       10375 |\r\n| 5-LOW           |       10455 |\r\n+-----------------+-------------+\r\n5 rows in set (8.455 sec)\r\n{code}\r\n\r\n11.4 debug build\r\n\r\n{code:sql}\r\nMariaDB [tpch]> select o_orderpriority, count(*) as order_count from ORDERS where o_orderdate >= date '1993-06-01' and o_orderdate < date '1993-06-01' + interval '3' month and exists ( select * from LINEITEM where l_orderkey = o_orderkey and l_commitdate < l_receiptdate) group by o_orderpriority order by o_orderpriority;\r\n+-----------------+-------------+\r\n| o_orderpriority | order_count |\r\n+-----------------+-------------+\r\n| 1-URGENT        |       10540 |\r\n| 2-HIGH          |       10754 |\r\n| 3-MEDIUM        |       10435 |\r\n| 4-NOT SPECIFIED |       10375 |\r\n| 5-LOW           |       10455 |\r\n+-----------------+-------------+\r\n5 rows in set (57.237 sec)\r\n{code}\r\n\r\nso yes, much slower\r\n\r\n11.4 get_tmp_table_costs()\r\n\r\n{code:c++}\r\n    /* Disk based table */\r\n    cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *\r\n                            tmp_table_optimizer_costs.disk_read_ratio) +\r\n                           row_copy_cost);\r\n{code}\r\n\r\nso the problem with this formula is that is assumes that if we don't need to do a disk read, then the lookup cost is zero.\r\n\r\nlet try  hacking 11.4 like this, adding in something for a cached read.\r\n\r\n{code:c++}\r\n    /* Disk based table */\r\n    cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *\r\n                            tmp_table_optimizer_costs.disk_read_ratio) +\r\n                           (HEAP_TEMPTABLE_LOOKUP_COST *\r\n                              (1-tmp_table_optimizer_costs.disk_read_ratio)) +\r\n                           row_copy_cost);\r\n{code}\r\n\r\n{code:sql}\r\nMariaDB [tpch]> select o_orderpriority, count(*) as order_count from ORDERS where o_orderdate >= date '1993-06-01' and o_orderdate < date '1993-06-01' + interval '3' month and exists ( select * from LINEITEM where l_orderkey = o_orderkey and l_commitdate < l_receiptdate) group by o_orderpriority order by o_orderpriority;\r\n+-----------------+-------------+\r\n| o_orderpriority | order_count |\r\n+-----------------+-------------+\r\n| 1-URGENT        |       10540 |\r\n| 2-HIGH          |       10754 |\r\n| 3-MEDIUM        |       10435 |\r\n| 4-NOT SPECIFIED |       10375 |\r\n| 5-LOW           |       10455 |\r\n+-----------------+-------------+\r\n5 rows in set (7.500 sec)\r\n{code}\r\n\r\nso yes, now comparable to 10.11\r\n\r\nThis needs to be discussed.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"created":"2025-09-24T18:49:42.000+0000","updated":"2025-09-24T18:49:42.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313681","id":"313681","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"body":"https://github.com/MariaDB/server/tree/bb-11.4-MDEV-37723","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"created":"2025-09-25T02:59:51.000+0000","updated":"2025-09-25T02:59:51.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313704","id":"313704","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"{code:cpp}\r\n#define DISK_TEMPTABLE_MEM_LOOKUP_COST  (HEAP_TEMPTABLE_LOOKUP_COST*2/3)\r\n{code}\r\n\r\nWhere does the 2/3 come from ? ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-25T08:02:37.000+0000","updated":"2025-09-25T08:02:37.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313705","id":"313705","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Some other notes\r\n* get_tmp_table_costs() seems to be the only place in the code that computes temporary table lookup costs ...\r\n* get_tmp_table_costs() is used by\r\n** Semi-join Materialization\r\n** Duplicate Weedout\r\n** Split Materialized\r\n \r\nNote that Derived-with-Keys is not in the list.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-25T08:11:59.000+0000","updated":"2025-09-25T08:11:59.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313714","id":"313714","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"in get_tmp_table_costs()\r\n{code}\r\n(gdb) p tmp_table_optimizer_costs.key_lookup_cost / HEAP_TEMPTABLE_LOOKUP_COST\r\n  $113 = 2.7071938870597005\r\n{code}\r\n\r\nso, lookup in an on-disk table is 2.7x more expensive ... \r\n{code:cpp}\r\n    cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *\r\n                            tmp_table_optimizer_costs.disk_read_ratio) +\r\n                           row_copy_cost);\r\n{code}\r\n\r\nbut if we just multiply that by  {{tmp_table_optimizer_costs.disk_read_ratio=0.02}}, we'll have on-disk lookup cost 0.054 of in-memory lookup? \r\n\r\nThe fix makes more sense","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-25T10:54:48.000+0000","updated":"2025-09-25T10:55:15.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313717","id":"313717","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Added print out of analyze members\r\njust print out: https://gist.github.com/spetrunia/e2065e3808a48d26275f03bc58f66170\r\n{code:js}\r\n              \"materialized\": {\r\n                \"unique\": 1,\r\n                \"materialization_cost\": 1390.770342,\r\n                \"lookup_cost\": 1.015815e-4,\r\n{code}\r\n\r\nRex's patch + print out: https://gist.github.com/spetrunia/2f59bd5a44545e757d387177f3e88002\r\n{code:js}\r\n              \"materialized\": {\r\n                \"unique\": 1,\r\n                \"materialization_cost\": 1997.41363,\r\n                \"lookup_cost\": 2.067486e-4,\r\n{code}\r\n\r\nmaterialization_cost is cost of \r\n* running the subselect and \r\n* writing its output  into a temporary table\r\n\r\nThe subselect has cost=988, which matches the computation time, r_table_time_ms=1135 .\r\n\r\n{code:js}\r\n                \"query_block\": {\r\n                  \"select_id\": 2,\r\n                  \"nested_loop\": [\r\n                    {\r\n                      \"table\": {\r\n                        \"table_name\": \"lineitem\",\r\n                        \"access_type\": \"ALL\",\r\n                         ...\r\n                        \"loops\": 1,\r\n                        \"r_loops\": 1,\r\n                        \"rows\": 5768377,\r\n                        \"r_rows\": 6001215,\r\n                        \"cost\": 988.397787,\r\n                        \"r_table_time_ms\": 1135.889148,\r\n                        \"r_other_time_ms\": 6104.717805,\r\n                        \"r_engine_stats\": {\r\n                          \"pages_accessed\": 56224\r\n                        },\r\n                        \"filtered\": 100,\r\n                        \"r_filtered\": 63.20880022,\r\n{code}\r\n\r\nThe whole materialization_cost is 1390 (before the patch) or 1997 (after the patch). \r\nRemoving the cost of running the subquery:\r\n1390 - 998 = 392\r\n1997 - 998 = 999\r\nThis is the (expected) cost of writing rows into the materialized table.\r\n\r\nHowever ANALYZE shows {{r_other_time_ms}}=6104, which is much higher.\r\nAnd note that we're writing only r_filtered=63% of the data we've intended to write (filtered=100%). \r\n\r\nEDIT: changing the subquery's WHERE to get r_filtered=100%: {{lineitem.l_commitDATE <> lineitem.l_receiptDATE}}, I get r_other_time_ms=8403. It's not 2x.\r\n\r\nEDIT2: changing to {{l_commitDATE = l_receiptDATE}} gives r_filtered=0.8287,  r_other_time_ms=228.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-25T11:49:56.000+0000","updated":"2025-09-26T10:07:33.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313802","id":"313802","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"How about in-memory temp table? \r\n\r\n{code:sql}\r\nset max_heap_table_size=240*1000*1000;\r\nset optimizer_switch='firstmatch=off'; -- I have Rex's patch, force Duplicate Weedout plan\r\nANALYZE ...\r\nSHOW STATUS LIKE 'Created_tmp_disk_tables'; -- Check that the table was in-memory\r\n{code}\r\n\r\ngives\r\n{code:js}\r\n              \"materialized\": {\r\n                \"unique\": 1,\r\n                \"materialization_cost\": 1930.421825,\r\n                \"lookup_cost\": 0.000195304,\r\n                \"query_block\": {\r\n                  \"select_id\": 2,\r\n                  \"nested_loop\": [\r\n                    {\r\n                      \"table\": {\r\n                        \"table_name\": \"lineitem\",\r\n                        \"access_type\": \"ALL\",\r\n                        \"possible_keys\": [\"PRIMARY\", \"IDX_LINEITEM_ORDERKEY_FKIDX\"],\r\n                        \"loops\": 1,\r\n                        \"r_loops\": 1,\r\n                        \"rows\": 5768377,\r\n                        \"r_rows\": 6001215,\r\n                        \"cost\": 988.397787,\r\n                        \"r_table_time_ms\": 1067.860569,\r\n                        \"r_other_time_ms\": 349.0458588,\r\n                        \"r_engine_stats\": {\r\n                          \"pages_accessed\": 56224\r\n                        },\r\n                        \"filtered\": 100,\r\n                        \"r_filtered\": 63.20880022,\r\n                        \"attached_condition\": \"lineitem.l_commitDATE < lineitem.l_receiptDATE\"\r\n                      }\r\n{code}\r\n\r\nFilling the table took 349 ms.  ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-26T09:50:17.000+0000","updated":"2025-09-26T09:50:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313805","id":"313805","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Change the subquery's WHERE to be non-selective: with {{lineitem.l_commitDATE <> lineitem.l_receiptDATE}}, I get:\r\n{code:js}\r\n                      \"table\": {\r\n                        \"table_name\": \"lineitem\",\r\n                        \"access_type\": \"ALL\",\r\n                        \"possible_keys\": [\"PRIMARY\", \"IDX_LINEITEM_ORDERKEY_FKIDX\"],\r\n                        \"loops\": 1,\r\n                        \"r_loops\": 1,\r\n                        \"rows\": 5768377,\r\n                        \"r_rows\": 6001215,\r\n                        \"cost\": 988.397787,\r\n                        \"r_table_time_ms\": 1071.987345,\r\n                        \"r_other_time_ms\": 407.4291329,\r\n                        \"r_engine_stats\": {\r\n                          \"pages_accessed\": 56224\r\n                        },\r\n                        \"filtered\": 100,\r\n                        \"r_filtered\": 99.17123449,\r\n                        \"attached_condition\": \"lineitem.l_commitDATE <> lineitem.l_receiptDATE\"\r\n                      }\r\n{code}\r\n(the temptable is still in-memory)\r\n\r\nnow r_other_time_ms=407.   Filling the temptable with half the data took r_other_time_ms=350 ....\r\n(and see EDIT2 a few messages above.  comparing two date fields takes around 200 ms)","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-26T09:55:16.000+0000","updated":"2025-09-26T10:13:21.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313806","id":"313806","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"So far I was looking at cost to write to the temp.table.\r\nThis is because the in get_tmp_table_costs() assumes the cost of writing is the same as lookup cost:\r\n\r\n{code:sql}\r\n     cost.write=           cost.lookup;\r\n{code}\r\n\r\nCan we verify the lookup cost?  With this query, it is not easy to do:\r\n{code:json}\r\n            \"table\": {\r\n              \"table_name\": \"<subquery2>\",\r\n              \"access_type\": \"eq_ref\",\r\n              \"possible_keys\": [\"distinct_key\"],\r\n              \"key\": \"distinct_key\",\r\n              \"key_length\": \"4\",\r\n              \"used_key_parts\": [\"l_orderkey\"],\r\n              \"ref\": [\"func\"],\r\n              \"r_loops\": 57280,\r\n              \"r_table_loops\": 1935,\r\n              \"rows\": 1,\r\n              \"r_rows\": 0.033205307,\r\n{code}\r\nthe eq_ref access on materialized table is done 57280 times (Much less than expected due to selectivity in {{orders}} table), and then r_table_loops=1935 - most of the lookups hit the eq-ref lookup cache.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-26T10:29:07.000+0000","updated":"2025-09-26T10:29:07.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313807","id":"313807","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":" [^mdev-37723-and-counters.diff] Patch that prints materialization costs.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-26T10:30:40.000+0000","updated":"2025-09-26T10:30:40.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313863","id":"313863","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"A draft (DO NOT RUN it) patch trying to check temptable use costs against the reality:  [^temptable-costs.sh] ","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-28T17:51:09.000+0000","updated":"2025-09-28T17:51:09.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313931","id":"313931","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=monty","name":"monty","key":"monty","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Michael Widenius","active":true,"timeZone":"Europe/Helsinki"},"body":"I agree that\r\ncost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *\r\n                        tmp_table_optimizer_costs.disk_read_ratio) +\r\n                        row_copy_cost);\r\n\r\nIs wrong. key_lookup_cost is the cost of operations in memory, not based on disk reads.\r\n\r\nShould be something like:\r\n\r\n\r\n{code:java}\r\n+++ b/sql/opt_subselect.cc\r\n@@ -2777,12 +2777,14 @@ get_tmp_table_costs(THD *thd, double row_count, uint row_size, bool blobs_used,\r\n                            tmp_table_optimizer_costs.row_copy_cost :\r\n                            0);\r\n     /* Disk based table */\r\n-    cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost *\r\n+    cost.lookup=          ((tmp_table_optimizer_costs.key_lookup_cost +\r\n+                            tmp_table_optimizer_costs.disk_read_cost *\r\n                             tmp_table_optimizer_costs.disk_read_ratio) +\r\n                            row_copy_cost);\r\n     cost.write=           cost.lookup;\r\n     cost.create=          DISK_TEMPTABLE_CREATE_COST;\r\n     cost.block_size=      DISK_TEMPTABLE_BLOCK_SIZE;\r\n+    /* The following costs are only used for table scans */\r\n     cost.avg_io_cost=     tmp_table_optimizer_costs.disk_read_cost;\r\n     cost.cache_hit_ratio= tmp_table_optimizer_costs.disk_read_ratio;\r\n\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=monty","name":"monty","key":"monty","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Michael Widenius","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-29T14:01:32.000+0000","updated":"2025-09-29T14:04:40.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313943","id":"313943","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"With the above patch, I get the 10.11's plan with First Match.\r\nRelevant parts of the trace:\r\n\r\n{code:json}\r\n          \"plan_prefix\": \"orders\",\r\n          \"table\": \"lineitem\",\r\n          \"rows_for_plan\": 4458963,\r\n          \"cost_for_plan\": 2217.051794,\r\n          \"semijoin_strategy_choice\": [\r\n            {\r\n              \"strategy\": \"FirstMatch\",\r\n              \"rows\": 1486321,\r\n              \"cost\": 2217.051794\r\n            },\r\n            {\r\n              \"strategy\": \"SJ-Materialization\",\r\n              \"rows\": 1486321,\r\n              \"cost\": 6378.430345\r\n            },\r\n            ...\r\n              \"chosen_strategy\": \"FirstMatch\"\r\n            ...\r\n          \"sj_rows_out\": 1,\r\n          \"sj_rows_for_plan\": 1486321,\r\n          \"sj_filtered\": 33.33333333,\r\n          \"cost_for_sorting\": 1015.061028\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-29T14:35:43.000+0000","updated":"2025-09-29T14:35:43.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313952","id":"313952","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"body":"this patch also passes my added test in main.costs\r\n\r\nhowever it also changes join order in a test main.subselect3, checking costs\r\n\r\n{code:sql}\r\ncreate table t0 (a int);\r\ninsert into t0 values (0),(1),(2),(3),(4),(5),(6),(7),(8),(9);\r\ncreate table t1 (a int) as select * from t0 where a < 5;\r\nset @save_max_heap_table_size=@@max_heap_table_size;\r\nset @@optimizer_switch='firstmatch=off,materialization=off';\r\nset @@max_heap_table_size= 16384;\r\n\r\nexplain format=json select count(*) from t0 A, t0 B, t0 C, t0 D where D.a in (select a from t1 E where a+1 < 10000 + A.a + B.a +C.a+D.a);\r\n{code}\r\n\r\njoin order now starts with A, used to start with E\r\n\r\nwas\r\n\r\n{noformat}\r\n1\tPRIMARY\tE\tALL\tNULL\tNULL\tNULL\tNULL\t5\tStart temporary\r\n1\tPRIMARY\tA\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing join buffer (flat, BNL join)\r\n1\tPRIMARY\tB\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing join buffer (flat, BNL join)\r\n1\tPRIMARY\tC\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing where; Using join buffer (flat, BNL join)\r\n1\tPRIMARY\tD\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing where; End temporary; Using join buffer (flat, BNL join)\r\n{noformat}\r\n\r\nnow\r\n\r\n{noformat}\r\nexplain select count(*) from t0 A, t0 B, t0 C, t0 D where D.a in (select a from t1 E where a+1 < 10000 + A.a + B.a +C.a+D.a);\r\nid\tselect_type\ttable\ttype\tpossible_keys\tkey\tkey_len\tref\trows\tExtra\r\n1\tPRIMARY\tA\tALL\tNULL\tNULL\tNULL\tNULL\t10\t\r\n1\tPRIMARY\tB\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing join buffer (flat, BNL join)\r\n1\tPRIMARY\tE\tALL\tNULL\tNULL\tNULL\tNULL\t5\tStart temporary; Using join buffer (flat, BNL join)\r\n1\tPRIMARY\tC\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing where; Using join buffer (flat, BNL join)\r\n1\tPRIMARY\tD\tALL\tNULL\tNULL\tNULL\tNULL\t10\tUsing where; End temporary; Using join buffer (flat, BNL join)\r\n{noformat}\r\n\r\nchecking execution times\r\n\r\nwas\r\n\r\n{noformat}\r\n  \"query_optimization\": {\r\n    \"r_total_time_ms\": 0.560495296\r\n  },\r\n  \"query_block\": {\r\n    \"select_id\": 1,\r\n    \"cost\": 16.85035133,\r\n    \"r_loops\": 1,\r\n    \"r_total_time_ms\": 21.87591639,\r\n{noformat}\r\n\r\nnow\r\n\r\n{noformat}\r\n  \"query_optimization\": {\r\n    \"r_total_time_ms\": 0.475663271\r\n  },\r\n  \"query_block\": {\r\n    \"select_id\": 1,\r\n    \"cost\": 25.01860986,\r\n    \"r_loops\": 1,\r\n    \"r_total_time_ms\": 20.88892192,\r\n{noformat}\r\n\r\n\r\nso it appears we have a slight slowdown in one place.\r\n\r\nChecking the optimizer traces\r\n\r\nwas\r\n\r\n{noformat}\r\n                                \"plan_prefix\": \"E,A,B,C\",\\\r\n                                \"table\": \"D\",\\\r\n                                \"rows_for_plan\": 50000,\\\r\n                                \"cost_for_plan\": 15.32741893,\\\r\n                                \"semijoin_strategy_choice\": [\\\r\n                                  {\\\r\n                                    \"strategy\": \"DuplicateWeedout\",\\\r\n                                    \"prefix_row_count\": 1,\\\r\n                                    \"tmp_table_rows\": 10000,\\\r\n                                    \"sj_inner_fanout\": 5,\\\r\n                                    \"rows\": 10000,\\\r\n                                    \"dups_cost\": 15.32741893,\\\r\n                                    \"write_cost\": 1.0871554,\\\r\n                                    \"full_lookup_cost\": 0.435777,\\\r\n                                    \"total_cost\": 16.85035133\\\r\n                                  },\\\r\n                                  {\\\r\n                                    \"chosen_strategy\": \"DuplicateWeedout\"\\\r\n                                  }\\\r\n                                ],\\\r\n                                \"sj_rows_out\": 2,\\\r\n                                \"sj_rows_for_plan\": 10000,\\\r\n                                \"sj_filtered\": 20\\\r\n                              }\\\r\n{noformat}\r\n\r\nnow\r\n\r\n{noformat}\r\n                                \"plan_prefix\": \"E,A,B,C\",\\\r\n                                \"table\": \"D\",\\\r\n                                \"rows_for_plan\": 50000,\\\r\n                                \"cost_for_plan\": 15.32741893,\\\r\n                                \"semijoin_strategy_choice\": [\\\r\n                                  {\\\r\n                                    \"strategy\": \"DuplicateWeedout\",\\\r\n                                    \"prefix_row_count\": 1,\\\r\n                                    \"tmp_table_rows\": 10000,\\\r\n                                    \"sj_inner_fanout\": 5,\\\r\n                                    \"rows\": 10000,\\\r\n                                    \"dups_cost\": 15.32741893,\\\r\n                                    \"write_cost\": 7.40577,\\\r\n                                    \"full_lookup_cost\": 32.02885,\\\r\n                                    \"total_cost\": 54.76203893\\\r\n                                  },\\\r\n                                  {\\\r\n                                    \"chosen_strategy\": \"DuplicateWeedout\"\\\r\n                                  }\\\r\n                                ],\\\r\n                                \"sj_rows_out\": 2,\\\r\n                                \"sj_rows_for_plan\": 10000,\\\r\n                                \"sj_filtered\": 20,\\\r\n                                \"pruned_by_cost\": true,\\\r\n                                \"current_cost\": 54.76203893,\\\r\n                                \"best_cost\": 25.01860986\\\r\n                              }\\\r\n{noformat}\r\n\r\nSo it appears that we've now pushed the tmp table costs up enough that the optimizer has pruned what used to be the optimal plan.  Calculated cost has now gone up (as we expect), and actual execution time is (slightly) reduced.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"created":"2025-09-29T16:55:15.000+0000","updated":"2025-09-30T01:13:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313991","id":"313991","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Discussed the above with Rex, identified a couple of objection points.  I don't think the plan regression is that big (if any at all).\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-30T07:46:17.000+0000","updated":"2025-09-30T07:46:17.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/313994","id":"313994","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"https://github.com/MariaDB/server/tree/bb-11.4-MDEV-37723-try2 - Patch, fails main.costs on some platforms.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-30T07:58:15.000+0000","updated":"2025-09-30T07:58:15.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/314013","id":"314013","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Checking that testcase from main.subselect3.\r\n\r\nThe above numbers were from debug build. It is much better to do cost-query time comparison on a release build. \r\n\r\nh3. With the patch\r\n\r\nThe query plan:  \r\n  A, bnl(B), Dups-Weedout( bnl(E), bnl(C), bnl(D))\r\n\r\n\"cost\":  25.01421709\r\n\r\nquery times (run the query several times):\r\n\r\n\"r_total_time_ms\": 34.83110628\r\n\"r_total_time_ms\": 24.49109701\r\n\"r_total_time_ms\": 24.02228386\r\n\r\n\r\nh3. Before the patch: \r\n\r\nThe query plan:\r\n  Dups-Weedout(E, bnl(A), bnl(B), bnl(C), bnl(D))\r\n\r\n\"cost\": 16.84595856,\r\n\r\nquery times (run the query several times):\r\n\"r_total_time_ms\": 37.29754185,\r\n\"r_total_time_ms\": 24.69256709,\r\n\"r_total_time_ms\": 24.03060852,\r\n\r\nh3. Interpretation\r\n\r\nLooking at the execution time: The query plan with the patch is not slower.\r\nThe cost with the patch is more in line with the execution time.\r\nThe cost without the patch is smaller, but this is what the patch fixes: the costs were too small.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-30T09:53:27.000+0000","updated":"2025-09-30T09:56:24.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/314034","id":"314034","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Fixed CI failures:\r\n{code}\r\n0eeef57ce3a (HEAD -> bb-11.4-MDEV-37723-try2, origin/bb-11.4-MDEV-37723-try2) Make the tests cleaner.\r\n504559665eb Attempt to get stable innodb costs.\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-30T16:13:07.000+0000","updated":"2025-09-30T16:13:07.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/314263","id":"314263","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"A patch against 11.8, fix is switchable with {{@@new_mode}}:\r\n{code}\r\ncommit 0785e755d86412f99d46b17456a3d046201e577e (HEAD -> 11.8-MDEV-37784, origin/HEAD, origin/11.8-MDEV-37784)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Mon Sep 29 19:36:26 2025 +0300\r\n\r\n    MDEV-37723: TPROC-H Query4 much slower in 11.4 than in 10.11\r\n    \r\n    (Patch provided by Monty, Testcase by Rex Johnston)\r\n    \r\n    get_tmp_table_costs() computes the cost of using a temporary (work\r\n    table) for certain cases, including semi-join subquery materialization.\r\n    \r\n    The computed cost value was very low, it used this formula:\r\n      key_lookup_cost * (disk_read_ratio= 0.05)\r\n    \r\n    Use the correct formula:\r\n    \r\n       key_lookup_cost // Index lookup is always done\r\n       +\r\n       disk_read_cost * disk_read_ratio\r\n    \r\n    disk_read_cost is incurred when the lookup has to go to disk.\r\n    We assume this doesn't occur for every lookup. It happens only with\r\n    disk_read_ratio=0.05 chance.\r\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-02T18:38:11.000+0000","updated":"2025-10-02T18:38:11.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/314267","id":"314267","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Also pushed this into bb-11.8-mdev-37723","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-02T18:47:48.000+0000","updated":"2025-10-02T18:47:48.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/314323","id":"314323","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Next variant.  Needs to be rebased on top of the final MDEV-37784, {{@@new_mode}} patch \r\n{code}\r\ncommit c17c381c5749963e2678ed374c332d824d3bc887 (HEAD -> bb-11.8-mdev-37723, origin/bb-11.8-mdev-37723)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Mon Sep 29 19:36:26 2025 +0300\r\n\r\n    MDEV-37723: TPROC-H Query4 much slower in 11.4 than in 10.11\r\n    \r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-03T11:37:15.000+0000","updated":"2025-10-03T11:37:15.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136714/comment/316619","id":"316619","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"This was fixed in 11.8:\r\n{code}\r\ncommit 8916aeed28af19a7f4d6ff2ab5f33190a2c9fcd2 (origin/bb-11.8-mdev37723-push)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Mon Sep 29 19:36:26 2025 +0300\r\n\r\n    MDEV-37723: TPROC-H Query4 much slower in 11.4 than in 10.11\r\n...\r\n{code}\r\n\r\nThe new_mode flag was removed in 12.1 by:\r\n{code}\r\ncommit 32940e34426039c58fcf2405e171fe9e20f5f85e\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Wed Oct 8 14:45:21 2025 +0300\r\n\r\n    MDEV-37723: TPROC-H Query4...: Remove @@new_mode=FIX_DISK_TMPTABLE_COSTS in 12.1\r\n    \r\n    In 12.1, remove the FIX_DISK_TMPTABLE_COSTS flag from @@new_mode.\r\n    The new behavior is now always on.\r\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-04T08:36:24.000+0000","updated":"2025-11-04T08:36:24.000+0000"}],"maxResults":22,"total":22,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"136560","self":"https://jira.mariadb.org/rest/api/2/issue/136560","key":"MDEV-37653","fields":{"summary":"IS TRUE incorrectly converts outer join to inner","description":"Hi,\r\n\r\nI found a logic bug in MariaDB when using a Boolean value as the parameter of a prepared statement. In the following test case, the where condition should return false, but the query still return one row:\r\n{code:sql}\r\nCREATE TABLE t0(c0 REAL);\r\nCREATE TABLE t1 LIKE t0;\r\nINSERT INTO t1 VALUES (1);\r\nINSERT INTO t0 VALUES (1);\r\nSET @a = false;\r\nPREPARE prepare_query FROM \"SELECT t1.c0, t0.c0 FROM t1 LEFT JOIN t0 ON 'J' WHERE (? OR ((t0.c0 IS TRUE) IN ('*_')))\";\r\nEXECUTE prepare_query USING @a;\r\n--- c0      c0\r\n--- 1       NULL\r\n{code}\r\n\r\nThe equivalent normal query returns an empty result, which is incorrect:\r\n{code:sql}\r\nSELECT t1.c0, t0.c0 FROM t1 LEFT JOIN t0 ON FALSE WHERE (FALSE OR ((t0.c0 IS TRUE) IN (FALSE)));\r\n{code}","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/136560/comment/313323","id":"313323","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ChiZhang","name":"ChiZhang","key":"JIRAUSER56610","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Chi Zhang","active":true,"timeZone":"Etc/UTC"},"body":"Hi, I found that the normal query produces an incorrect result, there is an equivalent query:\r\n\r\nSELECT t1.c0, t0.c0 FROM t1 LEFT JOIN t0 ON FALSE WHERE (FALSE OR ((t0.c0 IS TRUE) IN (FALSE)));\r\n\r\nThis query produces an empty result. However, the expression `t0.c0 IS TRUE` should return FALSE, and the WHERE condition should be TRUE.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ChiZhang","name":"ChiZhang","key":"JIRAUSER56610","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Chi Zhang","active":true,"timeZone":"Etc/UTC"},"created":"2025-09-22T02:58:57.000+0000","updated":"2025-09-22T02:58:57.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/136560/comment/314931","id":"314931","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"body":"[~serg] OK to push","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Gosselin","name":"Gosselin","key":"JIRAUSER52216","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52216&avatarId=27007","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52216&avatarId=27007","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52216&avatarId=27007","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52216&avatarId=27007"},"displayName":"Dave Gosselin","active":true,"timeZone":"Europe/Berlin"},"created":"2025-10-13T13:02:34.000+0000","updated":"2025-10-13T13:02:34.000+0000"}],"maxResults":2,"total":2,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"135994","self":"https://jira.mariadb.org/rest/api/2/issue/135994","key":"MDEV-37438","fields":{"summary":"Downcast of address to Item_func_eq but of type Item_func_equal in opt_split.cc(add_ext_keyuse_for_splitting) found with UBSAN","description":"The following script:\r\n{noformat}\r\nCREATE TABLE t1 (a int, b int, KEY t1_IDX (a,b)) ENGINE=INNODB;\r\nEXPLAIN SELECT t1.a,t1.b FROM t1\r\nLEFT JOIN\r\n(\r\nSELECT a, b FROM t1 GROUP BY a, b\r\n) AS t ON t1.a=t.a and t1.b<=>t.b;\r\n{noformat}\r\n\r\nleads to runtime error:\r\n{noformat}\r\n/src/mariadb/sql/opt_split.cc:697:26: runtime error: downcast of address 0x74985ef8f048 which does not point to an object of type 'Item_func_eq'\r\n{noformat}\r\n\r\nand subsequently triggers ASAN:\r\n{noformat}\r\nSUMMARY: AddressSanitizer: 32 byte(s) leaked in 2 allocation(s).\r\n250813  7:52:07 [ERROR] /src/mariadb/sql/mariadbd got signal 6 ;\r\n{noformat}\r\n\r\nwith the following stacktrace:\r\n{noformat}\r\n==12445==ERROR: LeakSanitizer: detected memory leaks\r\n\r\nDirect leak of 16 byte(s) in 1 object(s) allocated from:\r\n    #0 0x7cda56d2154b in realloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:81\r\n    #1 0x7cda560c3a5a  (/lib/x86_64-linux-gnu/libstdc++.so.6+0xc3a5a) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #2 0x7cda560cf9eb  (/lib/x86_64-linux-gnu/libstdc++.so.6+0xcf9eb) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #3 0x7cda560d0578 in __cxa_demangle (/lib/x86_64-linux-gnu/libstdc++.so.6+0xd0578) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #4 0x7cda5582fb9a in __sanitizer::Symbolizer::Demangle(char const*) ../../../../src/libsanitizer/sanitizer_common/sanitizer_symbolizer_libcdep.cpp:169\r\n    #5 0x7cda55808340 in RenderText ../../../../src/libsanitizer/ubsan/ubsan_diag.cpp:199\r\n    #6 0x7cda558098a5 in PrintMemorySnippet ../../../../src/libsanitizer/ubsan/ubsan_diag.cpp:329\r\n    #7 0x7cda558098a5 in __ubsan::Diag::~Diag() ../../../../src/libsanitizer/ubsan/ubsan_diag.cpp:385\r\n    #8 0x7cda5580f9b0 in HandleDynamicTypeCacheMiss ../../../../src/libsanitizer/ubsan/ubsan_handlers_cxx.cpp:69\r\n    #9 0x7cda5580fcae in __ubsan_handle_dynamic_type_cache_miss ../../../../src/libsanitizer/ubsan/ubsan_handlers_cxx.cpp:87\r\n    #10 0x5f9f60e05706 in add_ext_keyuse_for_splitting /src/mariadb/sql/opt_split.cc:697\r\n    #11 0x5f9f60e06f6d in add_ext_keyuses_for_splitting_field /src/mariadb/sql/opt_split.cc:761\r\n    #12 0x5f9f60e07976 in JOIN::add_keyuses_for_splitting() /src/mariadb/sql/opt_split.cc:836\r\n    #13 0x5f9f60e09ac9 in st_join_table::add_keyuses_for_splitting() /src/mariadb/sql/opt_split.cc:918\r\n    #14 0x5f9f5fc292f0 in make_join_statistics /src/mariadb/sql/sql_select.cc:6157\r\n    #15 0x5f9f5fbd29f4 in JOIN::optimize_inner() /src/mariadb/sql/sql_select.cc:2743\r\n    #16 0x5f9f5fbbef44 in JOIN::optimize() /src/mariadb/sql/sql_select.cc:2023\r\n    #17 0x5f9f5fc16e9d in mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*) /src/mariadb/sql/sql_select.cc:5388\r\n    #18 0x5f9f5fe219c9 in mysql_explain_union(THD*, st_select_lex_unit*, select_result*) /src/mariadb/sql/sql_select.cc:31662\r\n    #19 0x5f9f5f965569 in execute_sqlcom_select /src/mariadb/sql/sql_parse.cc:6106\r\n    #20 0x5f9f5f9361dd in mysql_execute_command(THD*, bool) /src/mariadb/sql/sql_parse.cc:3950\r\n    #21 0x5f9f5f98729f in mysql_parse(THD*, char*, unsigned int, Parser_state*) /src/mariadb/sql/sql_parse.cc:7883\r\n    #22 0x5f9f5f90455c in dispatch_command(enum_server_command, THD*, char*, unsigned int, bool) /src/mariadb/sql/sql_parse.cc:1878\r\n    #23 0x5f9f5f8f8975 in do_command(THD*, bool) /src/mariadb/sql/sql_parse.cc:1417\r\n    #24 0x5f9f605f0a37 in do_handle_one_connection(CONNECT*, bool) /src/mariadb/sql/sql_connect.cc:1414\r\n    #25 0x5f9f605efac6 in handle_one_connection /src/mariadb/sql/sql_connect.cc:1326\r\n    #26 0x5f9f62cf14b5 in pfs_spawn_thread /src/mariadb/storage/perfschema/pfs.cc:2198\r\n    #27 0x7cda56c5f972 in asan_thread_start ../../../../src/libsanitizer/asan/asan_interceptors.cpp:239\r\n    #28 0x7cda554a27f0 in start_thread nptl/pthread_create.c:448\r\n\r\nDirect leak of 16 byte(s) in 1 object(s) allocated from:\r\n    #0 0x7cda56d2154b in realloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:81\r\n    #1 0x7cda560c3a5a  (/lib/x86_64-linux-gnu/libstdc++.so.6+0xc3a5a) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #2 0x7cda560cf9eb  (/lib/x86_64-linux-gnu/libstdc++.so.6+0xcf9eb) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #3 0x7cda560d0578 in __cxa_demangle (/lib/x86_64-linux-gnu/libstdc++.so.6+0xd0578) (BuildId: 8d4f2235ec34ae33c412aa436c18ef4618f2efa6)\r\n    #4 0x7cda5582fb9a in __sanitizer::Symbolizer::Demangle(char const*) ../../../../src/libsanitizer/sanitizer_common/sanitizer_symbolizer_libcdep.cpp:169\r\n    #5 0x7cda55808340 in RenderText ../../../../src/libsanitizer/ubsan/ubsan_diag.cpp:199\r\n    #6 0x7cda5580907a in __ubsan::Diag::~Diag() ../../../../src/libsanitizer/ubsan/ubsan_diag.cpp:379\r\n    #7 0x7cda5580f9b0 in HandleDynamicTypeCacheMiss ../../../../src/libsanitizer/ubsan/ubsan_handlers_cxx.cpp:69\r\n    #8 0x7cda5580fcae in __ubsan_handle_dynamic_type_cache_miss ../../../../src/libsanitizer/ubsan/ubsan_handlers_cxx.cpp:87\r\n    #9 0x5f9f60e05706 in add_ext_keyuse_for_splitting /src/mariadb/sql/opt_split.cc:697\r\n    #10 0x5f9f60e06f6d in add_ext_keyuses_for_splitting_field /src/mariadb/sql/opt_split.cc:761\r\n    #11 0x5f9f60e07976 in JOIN::add_keyuses_for_splitting() /src/mariadb/sql/opt_split.cc:836\r\n    #12 0x5f9f60e09ac9 in st_join_table::add_keyuses_for_splitting() /src/mariadb/sql/opt_split.cc:918\r\n    #13 0x5f9f5fc292f0 in make_join_statistics /src/mariadb/sql/sql_select.cc:6157\r\n    #14 0x5f9f5fbd29f4 in JOIN::optimize_inner() /src/mariadb/sql/sql_select.cc:2743\r\n    #15 0x5f9f5fbbef44 in JOIN::optimize() /src/mariadb/sql/sql_select.cc:2023\r\n    #16 0x5f9f5fc16e9d in mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*) /src/mariadb/sql/sql_select.cc:5388\r\n    #17 0x5f9f5fe219c9 in mysql_explain_union(THD*, st_select_lex_unit*, select_result*) /src/mariadb/sql/sql_select.cc:31662\r\n    #18 0x5f9f5f965569 in execute_sqlcom_select /src/mariadb/sql/sql_parse.cc:6106\r\n    #19 0x5f9f5f9361dd in mysql_execute_command(THD*, bool) /src/mariadb/sql/sql_parse.cc:3950\r\n    #20 0x5f9f5f98729f in mysql_parse(THD*, char*, unsigned int, Parser_state*) /src/mariadb/sql/sql_parse.cc:7883\r\n    #21 0x5f9f5f90455c in dispatch_command(enum_server_command, THD*, char*, unsigned int, bool) /src/mariadb/sql/sql_parse.cc:1878\r\n    #22 0x5f9f5f8f8975 in do_command(THD*, bool) /src/mariadb/sql/sql_parse.cc:1417\r\n    #23 0x5f9f605f0a37 in do_handle_one_connection(CONNECT*, bool) /src/mariadb/sql/sql_connect.cc:1414\r\n    #24 0x5f9f605efac6 in handle_one_connection /src/mariadb/sql/sql_connect.cc:1326\r\n    #25 0x5f9f62cf14b5 in pfs_spawn_thread /src/mariadb/storage/perfschema/pfs.cc:2198\r\n    #26 0x7cda56c5f972 in asan_thread_start ../../../../src/libsanitizer/asan/asan_interceptors.cpp:239\r\n    #27 0x7cda554a27f0 in start_thread nptl/pthread_create.c:448\r\n\r\nSUMMARY: AddressSanitizer: 32 byte(s) leaked in 2 allocation(s).\r\n{noformat}\r\n\r\nThe issue is reproduced on main (e02f4d7e31), with ASAN and UBSAN enabled.","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/135994/comment/311352","id":"311352","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"body":"This is covered by the test case main.derived_split_innodb.\r\n\r\nThe common ancestor class of Item_func_eq and Item_func_equal is Item_bool_rowready_func2 and replacing the cast/type to this resolves the issue.\r\n\r\nThe only expectation of the add_ext_keyuse_for_splitting function for the cast here is that that \"arguments()\" method is there. This is provided by the \"Item_args\" ancestor class and casting to this also works.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"created":"2025-08-26T03:02:33.000+0000","updated":"2025-08-26T03:02:33.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135994/comment/311354","id":"311354","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"body":"Full UBSAN trce:\r\n{noformat:title= main.derived_split_innodb}\r\nVersion: '11.8.4-MariaDB-asan-log'  socket: '/dev/shm/normal/tmp/22/mysqld.1.sock'  port: 19630  Source distribution\r\n/home/buildbot/src/sql/opt_split.cc:655:26: runtime error: downcast of address 0x7ec4450ebc10 which does not point to an object of type 'Item_func_eq'\r\n0x7ec4450ebc10: note: object is of type 'Item_func_equal'\r\n 00 00 00 00  90 01 b4 f1 76 55 00 00  15 00 00 00 00 00 00 00  c0 7c 8e f2 76 55 00 00  07 00 00 00\r\n              ^~~~~~~~~~~~~~~~~~~~~~~\r\n              vptr for 'Item_func_equal'\r\n    #0 0x5576ef386149 in add_ext_keyuse_for_splitting(Dynamic_array<KEYUSE_EXT>*, KEY_FIELD*, unsigned int, unsigned int) /home/buildbot/src/sql/opt_split.cc:655:26\r\n    #1 0x5576ef386149 in add_ext_keyuses_for_splitting_field(Dynamic_array<KEYUSE_EXT>*, KEY_FIELD*) /home/buildbot/src/sql/opt_split.cc:719:11\r\n    #2 0x5576ef386149 in JOIN::add_keyuses_for_splitting() /home/buildbot/src/sql/opt_split.cc:794:12\r\n    #3 0x5576eeb39376 in make_join_statistics(JOIN*, List<TABLE_LIST>&, st_dynamic_array*) /home/buildbot/src/sql/sql_select.cc:6186:12\r\n    #4 0x5576eeb275ee in JOIN::optimize_inner() /home/buildbot/src/sql/sql_select.cc:2728:7\r\n    #5 0x5576eeb1925b in JOIN::optimize() /home/buildbot/src/sql/sql_select.cc:2010:10\r\n    #6 0x5576eeafd8cf in mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*) /home/buildbot/src/sql/sql_select.cc:5373:19\r\n    #7 0x5576eec272db in mysql_explain_union(THD*, st_select_lex_unit*, select_result*) /home/buildbot/src/sql/sql_select.cc:31535:10\r\n    #8 0x5576ee9fbaaa in execute_sqlcom_select(THD*, TABLE_LIST*) /home/buildbot/src/sql/sql_parse.cc:6129:12\r\n    #9 0x5576ee9e078d in mysql_execute_command(THD*, bool) /home/buildbot/src/sql/sql_parse.cc:3975:12\r\n    #10 0x5576ee9c3893 in mysql_parse(THD*, char*, unsigned int, Parser_state*) /home/buildbot/src/sql/sql_parse.cc:7905:18\r\n    #11 0x5576ee9ba84f in dispatch_command(enum_server_command, THD*, char*, unsigned int, bool) /home/buildbot/src/sql/sql_parse.cc:1903:7\r\n    #12 0x5576ee9c5e55 in do_command(THD*, bool) /home/buildbot/src/sql/sql_parse.cc:1416:17\r\n    #13 0x5576eefd539c in do_handle_one_connection(CONNECT*, bool) /home/buildbot/src/sql/sql_connect.cc:1415:11\r\n    #14 0x5576eefd4bd5 in handle_one_connection /home/buildbot/src/sql/sql_connect.cc:1327:5\r\n    #15 0x5576f01f30b8 in pfs_spawn_thread /home/buildbot/src/storage/perfschema/pfs.cc:2198:3\r\n    #16 0x5576ee466b46 in asan_thread_start(void*) asan_interceptors.cpp.o\r\n    #17 0x7ff44551c1f4  (/lib/x86_64-linux-gnu/libc.so.6+0x891f4) (BuildId: 79005c16293efa45b441fed45f4f29b138557e9e)\r\n    #18 0x7ff44559baff in clone (/lib/x86_64-linux-gnu/libc.so.6+0x108aff) (BuildId: 79005c16293efa45b441fed45f4f29b138557e9e)\r\n{noformat}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"created":"2025-08-26T03:28:57.000+0000","updated":"2025-08-26T03:28:57.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135994/comment/311355","id":"311355","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"body":"for review: https://github.com/MariaDB/server/pull/4260","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=danblack","name":"danblack","key":"danblack","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=17315","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=17315","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=17315","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=17315"},"displayName":"Daniel Black","active":true,"timeZone":"Australia/Sydney"},"created":"2025-08-26T03:29:38.000+0000","updated":"2025-08-26T03:29:38.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135994/comment/311358","id":"311358","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"body":"Approved in https://github.com/MariaDB/server/pull/4260","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Johnston","name":"Johnston","key":"JIRAUSER52533","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52533&avatarId=25913","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52533&avatarId=25913","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52533&avatarId=25913","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52533&avatarId=25913"},"displayName":"Rex Johnston","active":true,"timeZone":"Pacific/Norfolk"},"created":"2025-08-26T04:07:43.000+0000","updated":"2025-08-26T04:07:43.000+0000"}],"maxResults":4,"total":4,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"135988","self":"https://jira.mariadb.org/rest/api/2/issue/135988","key":"MDEV-37435","fields":{"summary":"Assertion `field' failed in virtual bool Item_field::fix_fields(THD *, Item **)","description":"{code:sql}\r\nCREATE TABLE t (a INT,a1 INT AS (a) VIRTUAL,INDEX (a1));\r\nSELECT a FROM t WHERE a=(SELECT a FROM t GROUP BY a HAVING a=2);\r\n{code}\r\n\r\nLeads to:\r\n\r\n{noformat:title=CS 12.2.0 e02f4d7e311e214ea62ff2e59599849e229f4165 (Debug, Clang) Build 07/08/2025}\r\nmariadbd: /test/12.2_dbg/sql/item.cc:6415: virtual bool Item_field::fix_fields(THD *, Item **): Assertion `field' failed.\r\n{noformat}\r\n\r\n{noformat:title=CS 12.2.0 e02f4d7e311e214ea62ff2e59599849e229f4165 (Debug, Clang) Build 07/08/2025}\r\nCore was generated by `/test/MD070825-mariadb-12.2.0-linux-x86_64-dbg/bin/mariadbd --no-defaults --max'.\r\nProgram terminated with signal SIGABRT, Aborted.\r\nDownload failed: Invalid argument.  Continuing without source file ./nptl/./nptl/pthread_kill.c.\r\n#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:44\r\n\r\n[Current thread is 1 (LWP 1502333)]\r\n(gdb) bt\r\n#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:44\r\n#1  __pthread_kill_internal (signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:78\r\n#2  __GI___pthread_kill (threadid=<optimized out>, signo=signo@entry=6)at ./nptl/pthread_kill.c:89\r\n#3  0x000073f4cfa4527e in __GI_raise (sig=sig@entry=6)at ../sysdeps/posix/raise.c:26\r\n#4  0x000073f4cfa288ff in __GI_abort () at ./stdlib/abort.c:79\r\n#5  0x000073f4cfa2881b in __assert_fail_base (fmt=0x73f4cfbd01e8 \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n%n\", assertion=assertion@entry=0x5e5f3c732ca0 \"field\", file=file@entry=0x5e5f3c7532c5 \"/test/12.2_dbg/sql/item.cc\", line=line@entry=6415, function=function@entry=0x5e5f3c754f2c \"virtual bool Item_field::fix_fields(THD *, Item **)\") at ./assert/assert.c:96\r\n#6  0x000073f4cfa3b517 in __assert_fail (assertion=0x5e5f3c732ca0 \"field\", file=0x5e5f3c7532c5 \"/test/12.2_dbg/sql/item.cc\", line=6415, function=0x5e5f3c754f2c \"virtual bool Item_field::fix_fields(THD *, Item **)\") at ./assert/assert.c:105\r\n#7  0x00005e5f3baa8983 in Item_field::fix_fields (this=0x73d9bc01ee40, thd=0x73d9bc000d58, reference=0x73d9bc01eff0)at /test/12.2_dbg/sql/item.cc:6415\r\n#8  0x00005e5f3b4f2a6a in Item::fix_fields_if_needed (this=0x73d9bc01ee40, thd=0x73d9bc000d58, ref=0x73d9bc01eff0) at /test/12.2_dbg/sql/item.h:1143\r\n#9  0x00005e5f3bb13932 in Item_func::fix_fields (this=0x73d9bc01ef68, thd=0x73d9bc000d58, ref=0x0) at /test/12.2_dbg/sql/item_func.cc:394\r\n#10 0x00005e5f3b60d66e in st_select_lex::pushdown_from_having_into_where (this=0x73d9bc01ae28, thd=0x73d9bc000d58, having=0x0)at /test/12.2_dbg/sql/sql_lex.cc:12447\r\n#11 0x00005e5f3b6aa0e4 in JOIN::optimize_inner (this=0x73d9bc01e178)at /test/12.2_dbg/sql/sql_select.cc:2495\r\n#12 0x00005e5f3b6a6348 in JOIN::optimize (this=0x73d9bc01e178)at /test/12.2_dbg/sql/sql_select.cc:2023\r\n#13 0x00005e5f3b5f0e4e in st_select_lex::optimize_unflattened_subqueries (this=0x73d9bc019f58, const_only=true) at /test/12.2_dbg/sql/sql_lex.cc:5075\r\n#14 0x00005e5f3b8987c7 in JOIN::optimize_constant_subqueries (this=0x73d9bc01d7b0) at /test/12.2_dbg/sql/opt_subselect.cc:5941\r\n#15 0x00005e5f3b6a954a in JOIN::optimize_inner (this=0x73d9bc01d7b0)at /test/12.2_dbg/sql/sql_select.cc:2378\r\n#16 0x00005e5f3b6a6348 in JOIN::optimize (this=0x73d9bc01d7b0)at /test/12.2_dbg/sql/sql_select.cc:2023\r\n#17 0x00005e5f3b69df99 in mysql_select (thd=0x73d9bc000d58, tables=0x73d9bc01a5b0, fields=@0x73d9bc01a210: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73d9bc01a560, last = 0x73d9bc01a560, elements = 1}, <No data fields>}, conds=0x73d9bc01cb88, og_num=0, order=0x0, group=0x0, having=0x0, proc_param=0x0, select_options=2164525824, result=0x73d9bc01d788, unit=0x73d9bc005158, select_lex=0x73d9bc019f58)at /test/12.2_dbg/sql/sql_select.cc:5388\r\n#18 0x00005e5f3b69dad5 in handle_select (thd=0x73d9bc000d58, lex=0x73d9bc005078, result=0x73d9bc01d788, setup_tables_done_option=0)at /test/12.2_dbg/sql/sql_select.cc:634\r\n#19 0x00005e5f3b645611 in execute_sqlcom_select (thd=0x73d9bc000d58, all_tables=0x73d9bc01a5b0) at /test/12.2_dbg/sql/sql_parse.cc:6167\r\n#20 0x00005e5f3b63a39e in mysql_execute_command (thd=0x73d9bc000d58, is_called_from_prepared_stmt=false) at /test/12.2_dbg/sql/sql_parse.cc:3950\r\n#21 0x00005e5f3b632664 in mysql_parse (thd=0x73d9bc000d58, rawbuf=0x73d9bc019e80 \"SELECT a FROM t WHERE a=(SELECT a FROM t GROUP BY a HAVING a=2)\", length=63, parser_state=0x73f4cc127a10)at /test/12.2_dbg/sql/sql_parse.cc:7883\r\n#22 0x00005e5f3b62fa38 in dispatch_command (command=COM_QUERY, thd=0x73d9bc000d58, packet=0x73d9bc00b1f9 \"SELECT a FROM t WHERE a=(SELECT a FROM t GROUP BY a HAVING a=2)\", packet_length=63, blocking=true)at /test/12.2_dbg/sql/sql_parse.cc:1878\r\n#23 0x00005e5f3b633213 in do_command (thd=0x73d9bc000d58, blocking=true)at /test/12.2_dbg/sql/sql_parse.cc:1417\r\n#24 0x00005e5f3b8204b9 in do_handle_one_connection (connect=0x5e5f65737038, put_in_cache=true) at /test/12.2_dbg/sql/sql_connect.cc:1414\r\n#25 0x00005e5f3b82025e in handle_one_connection (arg=0x5e5f6566b3a8)at /test/12.2_dbg/sql/sql_connect.cc:1326\r\n#26 0x000073f4cfa9caa4 in start_thread (arg=<optimized out>)at ./nptl/pthread_create.c:447\r\n#27 0x000073f4cfb29c3c in clone3 ()at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:78\r\n{noformat}\r\n\r\n{noformat:title=Bug Detection Matrix}\r\n    Rel    o/d  Build   Commit                                    UniqueID observed             \r\nCS  10.6   dbg  040825  317f099ca56130a14a45b7250996c207cc95d461  No bug found                  \r\nCS  10.6   opt  040825  317f099ca56130a14a45b7250996c207cc95d461  No bug found                  \r\nCS  10.11  dbg  040825  55a39f13e40807c3c8fee4573380f3e4d93e8715  No bug found                  \r\nCS  10.11  opt  040825  55a39f13e40807c3c8fee4573380f3e4d93e8715  No bug found                  \r\nCS  11.4   dbg  040825  4e9c252bc4bfef525ff8ec4a37fabd957694285d  No bug found                  \r\nCS  11.4   opt  040825  4e9c252bc4bfef525ff8ec4a37fabd957694285d  No bug found                  \r\nCS  11.8   dbg  130825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  11.8   opt  130825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  12.1   dbg  100725  891108ed665cbcf882454caa16ec2565ed36e337  No bug found                  \r\nCS  12.1   dbg  130825  033471a367b4c60b7262e64f43f46b02e95b9d74  field|SIGABRT|Item_field::fix_fields|Item::fix_fields_if_needed|Item_func::fix_fields|st_select_lex::pushdown_from_having_into_where\r\nCS  12.1   opt  130825  033471a367b4c60b7262e64f43f46b02e95b9d74  SIGSEGV|Item_field::fix_fields|Item::fix_fields_if_needed|Item_func::fix_fields|st_select_lex::pushdown_from_having_into_where\r\nCS  12.2   dbg  130825  e02f4d7e311e214ea62ff2e59599849e229f4165  field|SIGABRT|Item_field::fix_fields|Item::fix_fields_if_needed|Item_func::fix_fields|st_select_lex::pushdown_from_having_into_where\r\nCS  12.2   opt  130825  e02f4d7e311e214ea62ff2e59599849e229f4165  SIGSEGV|Item_field::fix_fields|Item::fix_fields_if_needed|Item_func::fix_fields|st_select_lex::pushdown_from_having_into_where\r\nES  10.5   dbg  040825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.5   opt  040825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.6   dbg  040825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  10.6   opt  040825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  11.4   dbg  040825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\nES  11.4   opt  040825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\n{noformat}\r\n\r\nThe assertion happens after this commit \r\n{noformat}\r\ncommit 8cdee25952763a0401e4c2a4d61e92c13499bdc6\r\nAuthor: Yuchen Pei <ycp@mariadb.com>\r\nDate:   Wed Jun 4 11:43:30 2025 +1000\r\n\r\n    MDEV-36132 Substitute vcol expressions with indexed vcol fields in ORDER BY and GROUP BY\r\n    \r\n    Also expand vcol field index coverings to include indexes covering all\r\n    the fields in the expression. The reasoning goes as follows: let f(c1,\r\n    c2, ..., cn) be a function on applied to columns c1, c2, ..., cn, if\r\n    f(...) is covered by an index, so should vc whose expression is\r\n    f(...).\r\n    \r\n    For example, if t.vf = t.c1 + t.c2, and t has three indexes (vf), (c1,\r\n    c2), (c1).\r\n[..]\r\n{noformat}\r\n\r\nNo UB/ASAN issues observed.","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/312558","id":"312558","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"The surface cause is that the field appearance {{a}} in the HAVING item is an Item_ref pointing the GROUP BY Item_field. The vcol GROUP BY vcol index substitution causes the Item_ref to point to a newly created Item_field of {{a1}} which is created with no name resolution (context==NULL). Then, during pushdown HAVING into WHERE, the Item_field {{a1}} is cleaned up in a call to cleanup_excluding_immutables_processor, causing its {{field}} to be set to NULL. The subsequent fix_fields thus fails:\n\n{code:c++}\n/* in st_select_lex::pushdown_from_having_into_where: */\n    if (item->walk(&Item::cleanup_excluding_immutables_processor,\n                   0, WALK_NO_CACHE_PROCESS)\n        || item->fix_fields(thd, NULL))\n/* in Item_field::fix_fields: */\n  if (context)\n  {\n    select= context->select_lex;\n  }\n  else\n  {\n    // No real name resolution, used somewhere in SP\n    DBUG_ASSERT(field);\n    select= NULL;\n  }\n{code}\n\nIf the index is on {{a}} instead of {{a1}}, in which case no vcol subst happens, the Item_field pointing to {{a}} has name resolution thus avoiding this assert failure.\n\nThe WHERE vcol index substitution MDEV-35616 does not cause the same trouble:\n\nSELECT a FROM t WHERE a=(SELECT a FROM t WHERE a < 5 group by a1 HAVING a>2);\n\nbecause the Item_ref {{a}} in HAVING does not point to the Item_field {{a}} in WHERE, so the subst of the latter does not cause the same for the former. And since HAVING remains a>2 which does not depend on the GROUP BY field a1, there is no pushdown at all, let alone fix_fields.\n\nIf the vcol is not a field, then the problem does not occur either, presumably because the vcol expr in HAVING (i.e. a + 1) does not get auto substed when the same expr in GROUP BY is substed:\n\n{code:sql}\nCREATE TABLE t (a INT,a1 INT AS (a+1) VIRTUAL,INDEX (a1));\nSELECT a FROM t WHERE a=(SELECT a FROM t group by a + 1 HAVING a + 1>2);\n{code}\n\nSo perhaps one solution is to make the new vcol Item_field inherit the column's context when a substitution of a field by a vcol field happens.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-10T05:52:44.000+0000","updated":"2025-09-10T07:29:50.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/312564","id":"312564","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"BTW there is no need for the subquery, as the following already fails at the same assertion:\n\nSELECT a FROM t GROUP BY a HAVING a>2;\n\nI haven't checked but I suspect it is the same problem.  \n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-10T07:23:28.000+0000","updated":"2025-09-10T07:23:28.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/312657","id":"312657","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Hi [~psergei], ptal thanks\r\n\r\n{noformat}\r\n499ea7fb4a7 bb-12.1-mdev-37435 MDEV-37435 Make single field vcol inherit name resolution from the field in vcol index substitution\r\n{noformat}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-11T05:19:50.000+0000","updated":"2025-09-11T05:19:50.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/313469","id":"313469","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Looking...\r\n{code}\r\n    When a column is both the GROUP BY item, and when a HAVING conjunct\r\n    depends on this column only, the HAVING conjunct could contain an\r\n    Item_ref pointing to the GROUP BY Item_field.\r\n{code}\r\n\r\n>   When a column is both the GROUP BY item\r\n\r\nBoth GROUP BY item and what?\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-23T07:51:59.000+0000","updated":"2025-09-23T07:51:59.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/313470","id":"313470","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"But there's a bigger question: what if VCOL_EXPR is not an Item_field ? \r\nExample:\r\n\r\n{code:sql}\r\ncreate table t2 (\r\n  a int, \r\n  vcol int as (a+1) virtual, \r\n  index(vcol)\r\n);\r\nselect (a+1) as GRP from t2 group by GRP having GRP>2;\r\n{code}\r\n\r\nThis crashes both before and after this patch (as the patch obviously doesn't handle this): \r\n{code}\r\n  mysqld: /home/psergey/dev-git2/12.1-review/sql/item.cc:6415: virtual bool Item_field::fix_fields(THD*, Item**): Assertion `field' failed.\r\n\r\n(gdb) wher 10\r\n  #0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51\r\n  #1  0x00007ffff5a847f1 in __GI_abort () at abort.c:79\r\n  #2  0x00007ffff5a743fa in __assert_fail_base (fmt=0x7ffff5bfb6c0 \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n%n\", assertion=assertion@entry=0x555557182155 \"field\",      file=file@entry=0x555557181298 \"/home/psergey/dev-git2/12.1-review/sql/item.cc\", line=line@entry=6415, function=function@entry=0x555557185820 <Item_field::     fix_fields(THD*, Item**)::__PRETTY_FUNCTION__> \"virtual bool Item_field::fix_fields(THD*, Item**)\") at assert.c:92\r\n  #3  0x00007ffff5a74472 in __GI___assert_fail (assertion=0x555557182155 \"field\", file=0x555557181298 \"/home/psergey/dev-git2/12.1-review/sql/item.cc\",         line=6415, function=0x555557185820 <Item_field::fix_fields(THD*, Item**)::__PRETTY_FUNCTION__> \"virtual bool Item_field::fix_fields(THD*, Item**)\") at assert.c:101\r\n  #4  0x00005555565126e5 in Item_field::fix_fields (this=0x7fff2801b7d8, thd=0x7fff28000d78, reference=0x7fff2801a250) at /home/psergey/dev-git2/12.1-review/sql/item.cc:6415\r\n  #5  0x0000555555f65004 in Item::fix_fields_if_needed (this=0x7fff2801b7d8, thd=0x7fff28000d78, ref=0x7fff2801a250) at /home/psergey/dev-git2/12.1-review/sql/ item.h:1143\r\n  #6  0x000055555657124f in Item_func::fix_fields (this=0x7fff2801a1c8, thd=0x7fff28000d78, ref=0x0) at /home/psergey/dev-git2/12.1-review/sql/item_func.cc:394\r\n  #7  0x000055555607ea2c in st_select_lex::pushdown_from_having_into_where (this=0x7fff280190e0, thd=0x7fff28000d78, having=0x0) at /home/psergey/dev-git2/12.1-review/sql/sql_lex.cc:12468\r\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-23T07:54:31.000+0000","updated":"2025-09-23T07:54:31.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/313472","id":"313472","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"So if we've created an Item_field\r\n{code:cpp}\r\n   Item_field *itf= new (thd->mem_root) Item_field(thd, vcol_field);\r\n{code}\r\nI think it is ok that we have to set {{itf->context}}.   Doesn't win an architecture award but apparently this is what a lot of code expects.\r\n\r\nWhere to get the context from? \r\nOption 1: Create a single-table (dummy) name resolution context for the table the VCOL is from.\r\nOption 2: find out which name resolution context  was used to resolve the VCOL_EXPR that we're replacing and use that.\r\n\r\nI *think* Option 1 is sufficient.   Option 2 seems to be much more complex to implement.  \r\nAny thoughts? \r\n\r\n\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-09-23T07:59:57.000+0000","updated":"2025-09-23T07:59:57.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/313688","id":"313688","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"> Both GROUP BY item and what?\r\n\r\nFixed the grammatical error in the commit message.\r\n\r\n> Where to get the context from?\r\n\r\nHow about we use the one from select_lex?\r\n\r\nI debugged the following testcase\r\n\r\n{code:sql}\r\nCREATE TABLE t1 (a INT,a1 INT AS (a) VIRTUAL,INDEX (a1));\r\nCREATE TABLE t2 (b INT,b1 INT AS (b) VIRTUAL,INDEX (b1));\r\ninsert into t1 (a) select seq from seq_1_to_10;\r\ninsert into t2 (b) select seq from seq_1_to_10;\r\nSELECT a, b FROM t1, t2 GROUP BY a, b HAVING a>2 and b>2;\r\ndrop table t1, t2;\r\n{code}\r\n\r\nand can see the original GROUP BY items have the same context as select_lex->context\r\n\r\n{noformat}\r\nThread 2 hit Breakpoint 3, substitute_indexed_vcols_for_join (join=0x52d0000fd268) at /home/ycp/source/mariadb-server/12.1/src/sql/opt_vcol_substitution.cc:304\r\n304\t  if (join->group_list)\r\n(rr) p join->group_list->item[0]->context\r\n$12 = (Name_resolution_context *) 0x52d0000fa560\r\n(rr) p join->group_list->next->item[0]->context\r\n$13 = (Name_resolution_context *) 0x52d0000fa560\r\n(rr) p &join->select_lex->context\r\n$14 = (Name_resolution_context *) 0x52d0000fa560\r\n{noformat}\r\n\r\nThe context was assigned during Item_field creation\r\n\r\n{code:c++}\r\n/* in LEX::create_item_ident_field: */\r\n    return new (thd->mem_root) Item_field(thd, current_context(),\r\n                                          db, table, name);\r\n{code}\r\n\r\nwhere context was pushed\r\n\r\n{code:c++}\r\n/* in push_select: */\r\n    if (push_context(&select_lex->context))\r\n      DBUG_RETURN(TRUE);\r\n{code}\r\n\r\nI don't see why it won't work where conds subst.\r\n\r\nAlso, the assertion failure happens in Item_field::fix_fields, where the context is accessed for the select_lex:\r\n\r\n{code:c++}\r\n// in Item_field::fix_fields:\r\n  SELECT_LEX *select;\r\n  if (context)\r\n  {\r\n    select= context->select_lex;\r\n  }\r\n{code}\r\n\r\nI amended the patch with this idea (see below). [~psergei]: ptal and let me know if my reasoning is not sufficient and I should look further into it\r\n\r\n{noformat}\r\n77cf457209a upstream/bb-12.1-mdev-37435 MDEV-37435 Make new vcols created in vcol index substitution inherit name resolution from the select_lex\r\n{noformat}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-25T04:47:22.000+0000","updated":"2025-09-25T04:56:15.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/315147","id":"315147","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"[~ycp], looks good. \r\nPlease change the table name in the testcase from \"t\" to \"t1\" and then it's ok to push.\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-10-15T10:34:56.000+0000","updated":"2025-10-15T10:34:56.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135988/comment/315196","id":"315196","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Thanks for the review\r\n\r\n>  Please change the table name in the testcase from \"t\" to \"t1\" and then it's ok to push.\r\n\r\nDone and pushed 0316c6e4f21dee02f5adfbe5c62471ee75ca20bb to 12.1\r\n\r\nChecked what happens when assertions are commented out, and it crashed with SEGV on NULL context, and wrote the release note summary accordingly.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-10-16T00:22:24.000+0000","updated":"2025-10-16T00:22:24.000+0000"}],"maxResults":9,"total":9,"startAt":0}}},{"expand":"operations,versionedRepresentations,editmeta,changelog,renderedFields","id":"135944","self":"https://jira.mariadb.org/rest/api/2/issue/135944","key":"MDEV-37422","fields":{"summary":"SIGSEGV failed in base_list_iterator::replace, Assertion `n < m_size' in Bounds_checked_array, ASAN use-after-poison in JOIN::rollup_make_fields","description":"{code:sql}\r\n--source include/have_innodb.inc\r\n\r\nCREATE TABLE t (a INT,b INT,a1 INT GENERATED ALWAYS AS (a) VIRTUAL,INDEX (a1)) ENGINE=INNODB;\r\nSELECT * FROM t GROUP BY a WITH ROLLUP;\r\n{code}\r\n\r\nLeads to:\r\n{noformat:title=CS 12.1.2 033471a367b4c60b7262e64f43f46b02e95b9d74 (Optimized, Clang) Build 08/08/2025}\r\nCore was generated by `/test/MD080825-mariadb-12.1.2-linux-x86_64-opt/bin/mariadbd --no-defaults --max'.\r\nProgram terminated with signal SIGSEGV, Segmentation fault.\r\n#0  base_list_iterator::replace (element=0x7652a801c6f0, this=<optimized out>)at /test/12.1_opt/sql/sql_list.h:450\r\n\r\n[Current thread is 1 (LWP 2417744)]\r\n(gdb) bt\r\n#0  base_list_iterator::replace (element=0x7652a801c6f0, this=<optimized out>)at /test/12.1_opt/sql/sql_list.h:450\r\n#1  List_iterator<Item>::replace (a=0x7652a801c6f0, this=<optimized out>)at /test/12.1_opt/sql/sql_list.h:594\r\n#2  JOIN::rollup_make_fields (this=this@entry=0x7652a8019028, fields_arg=@0x7652a8019410: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x7652a801c4c8, last = 0x7652a801cb10, elements = 4}, <No data fields>}, sel_fields=@0x7652a8019458: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x7652a801c6e0, last = 0x7652a801cb10, elements = 3}, <No data fields>}, func=func@entry=0x76537bf12578) at /test/12.1_opt/sql/sql_select.cc:30541\r\n#3  0x000059963ff04464 in JOIN::make_sum_func_list (this=this@entry=0x7652a8019028, field_list=@0x7652a8019410: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x7652a801c4c8, last = 0x7652a801cb10, elements = 4}, <No data fields>}, send_result_set_metadata=@0x7652a8019458: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x7652a801c6e0, last = 0x7652a801cb10, elements = 3}, <No data fields>}, before_group_by=true) at /test/12.1_opt/sql/sql_select.cc:29689\r\n#4  0x000059963ff134a7 in JOIN::make_aggr_tables_info (this=this@entry=0x7652a8019028) at /test/12.1_opt/sql/sql_select.cc:4193\r\n#5  0x000059963ff05cd7 in JOIN::optimize_stage2 (this=this@entry=0x7652a8019028) at /test/12.1_opt/sql/sql_select.cc:3538\r\n#6  0x000059963ff0712a in JOIN::optimize_inner (this=this@entry=0x7652a8019028)at /test/12.1_opt/sql/sql_select.cc:2769\r\n#7  0x000059963ff04914 in JOIN::optimize (this=this@entry=0x7652a8019028)at /test/12.1_opt/sql/sql_select.cc:2023\r\n#8  0x000059963fefe892 in mysql_select (thd=thd@entry=0x7652a8000c68, tables=<optimized out>, fields=@0x7652a80179e0: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x7652a8017d28, last = 0x7652a8019bc0, elements = 3}, <No data fields>}, conds=<optimized out>, og_num=<optimized out>, order=<optimized out>, group=0x7652a80185f0, having=0x0, proc_param=0x0, select_options=<optimized out>, result=0x7652a8019000, unit=0x7652a8005090, select_lex=0x7652a8017728)at /test/12.1_opt/sql/sql_select.cc:5388\r\n#9  0x000059963fefe5b9 in handle_select (thd=thd@entry=0x7652a8000c68, lex=lex@entry=0x7652a8004fb0, result=result@entry=0x7652a8019000, setup_tables_done_option=setup_tables_done_option@entry=0)at /test/12.1_opt/sql/sql_select.cc:634\r\n#10 0x000059963fec8487 in execute_sqlcom_select (thd=thd@entry=0x7652a8000c68, all_tables=0x7652a8017d78) at /test/12.1_opt/sql/sql_parse.cc:6167\r\n#11 0x000059963fec6fa1 in mysql_execute_command (thd=thd@entry=0x7652a8000c68, is_called_from_prepared_stmt=false) at /test/12.1_opt/sql/sql_parse.cc:3950\r\n#12 0x000059963febf3f1 in mysql_parse (thd=thd@entry=0x7652a8000c68, rawbuf=<optimized out>, length=<optimized out>, parser_state=parser_state@entry=0x76537bf13420)at /test/12.1_opt/sql/sql_parse.cc:7883\r\n#13 0x000059963febd90f in dispatch_command (command=command@entry=COM_QUERY, thd=thd@entry=0x7652a8000c68, packet=packet@entry=0x7652a80089f9 \"SELECT * FROM t GROUP BY a WITH ROLLUP\", packet_length=packet_length@entry=38, blocking=true)at /test/12.1_opt/sql/sql_parse.cc:1878\r\n#14 0x000059963febf801 in do_command (thd=thd@entry=0x7652a8000c68, blocking=true) at /test/12.1_opt/sql/sql_parse.cc:1417\r\n#15 0x00005996400150ed in do_handle_one_connection (connect=<optimized out>, connect@entry=0x599641dd7a88, put_in_cache=true)at /test/12.1_opt/sql/sql_connect.cc:1414\r\n#16 0x0000599640014eaf in handle_one_connection (arg=arg@entry=0x599641dd7a88)at /test/12.1_opt/sql/sql_connect.cc:1326\r\n#17 0x00005996401d7a79 in pfs_spawn_thread (arg=0x599641d7d958)at /test/12.1_opt/storage/perfschema/pfs.cc:2198\r\n#18 0x000076537cc9ca94 in start_thread (arg=<optimized out>)at ./nptl/pthread_create.c:447\r\n#19 0x000076537cd29c3c in clone3 ()at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:78\r\n{noformat}\r\n\r\n{noformat:title=CS 12.2.0 e02f4d7e311e214ea62ff2e59599849e229f4165 (Debug, Clang) Build 07/08/2025}\r\nmariadbd: /test/12.2_dbg/sql/sql_array.h:65: Element_type &Bounds_checked_array<Item *>::operator[](size_t) [Element_type = Item *]: Assertion `n < m_size' failed.\r\n{noformat}\r\n\r\n{noformat:title=CS 12.2.0 e02f4d7e311e214ea62ff2e59599849e229f4165 (Debug, Clang) Build 07/08/2025}\r\nCore was generated by `/test/MD070825-mariadb-12.2.0-linux-x86_64-dbg/bin/mariadbd --no-defaults --max'.\r\nProgram terminated with signal SIGABRT, Aborted.\r\nDownload failed: Invalid argument.  Continuing without source file ./nptl/./nptl/pthread_kill.c.\r\n#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:44\r\n\r\n[Current thread is 1 (LWP 2240059)]\r\n(gdb) bt\r\n#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:44\r\n#1  __pthread_kill_internal (signo=6, threadid=<optimized out>)at ./nptl/pthread_kill.c:78\r\n#2  __GI___pthread_kill (threadid=<optimized out>, signo=signo@entry=6)at ./nptl/pthread_kill.c:89\r\n#3  0x000073768b44527e in __GI_raise (sig=sig@entry=6)at ../sysdeps/posix/raise.c:26\r\n#4  0x000073768b4288ff in __GI_abort () at ./stdlib/abort.c:79\r\n#5  0x000073768b42881b in __assert_fail_base (fmt=0x73768b5d01e8 \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n%n\", assertion=assertion@entry=0x5f2960d0722b \"n < m_size\", file=file@entry=0x5f2960d03312 \"/test/12.2_dbg/sql/sql_array.h\", line=line@entry=65, function=function@entry=0x5f2960d07236 \"Element_type &Bounds_checked_array<Item *>::operator[](size_t) [Element_type = Item *]\") at ./assert/assert.c:96\r\n#6  0x000073768b43b517 in __assert_fail (assertion=0x5f2960d0722b \"n < m_size\", file=0x5f2960d03312 \"/test/12.2_dbg/sql/sql_array.h\", line=65, function=0x5f2960d07236 \"Element_type &Bounds_checked_array<Item *>::operator[](size_t) [Element_type = Item *]\") at ./assert/assert.c:105\r\n#7  0x00005f295fb3290d in Bounds_checked_array<Item*>::operator[] (this=0x7376802c0098, n=3) at /test/12.2_dbg/sql/sql_array.h:65\r\n#8  0x00005f295fd4a4be in JOIN::rollup_make_fields (this=0x73579c01b828, fields_arg=@0x73579c01bc18: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73579c01ee90, last = 0x73579c01f4d8, elements = 4}, <No data fields>}, sel_fields=@0x73579c01bc60: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73579c01f0a8, last = 0x73579c01f4d8, elements = 3}, <No data fields>}, func=0x7376802c0160) at /test/12.2_dbg/sql/sql_select.cc:30537\r\n#9  0x00005f295fd01865 in JOIN::make_sum_func_list (this=0x73579c01b828, field_list=@0x73579c01bc18: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73579c01ee90, last = 0x73579c01f4d8, elements = 4}, <No data fields>}, send_result_set_metadata=@0x73579c01bc60: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73579c01f0a8, last = 0x73579c01f4d8, elements = 3}, <No data fields>}, before_group_by=true) at /test/12.2_dbg/sql/sql_select.cc:29689\r\n#10 0x00005f295fd18c1f in JOIN::make_aggr_tables_info (this=0x73579c01b828)at /test/12.2_dbg/sql/sql_select.cc:4193\r\n#11 0x00005f295fd047e9 in JOIN::optimize_stage2 (this=0x73579c01b828)at /test/12.2_dbg/sql/sql_select.cc:3538\r\n#12 0x00005f295fd071ee in JOIN::optimize_inner (this=0x73579c01b828)at /test/12.2_dbg/sql/sql_select.cc:2769\r\n#13 0x00005f295fd02348 in JOIN::optimize (this=0x73579c01b828)at /test/12.2_dbg/sql/sql_select.cc:2023\r\n#14 0x00005f295fcf9f99 in mysql_select (thd=0x73579c000d58, tables=0x73579c01a578, fields=@0x73579c01a1e0: {<base_list> = {<Sql_alloc> = {<No data fields>}, first = 0x73579c01a528, last = 0x73579c01c3d0, elements = 3}, <No data fields>}, conds=0x0, og_num=1, order=0x0, group=0x73579c01adf0, having=0x0, proc_param=0x0, select_options=2164525824, result=0x73579c01b800, unit=0x73579c005158, select_lex=0x73579c019f28)at /test/12.2_dbg/sql/sql_select.cc:5388\r\n#15 0x00005f295fcf9ad5 in handle_select (thd=0x73579c000d58, lex=0x73579c005078, result=0x73579c01b800, setup_tables_done_option=0)at /test/12.2_dbg/sql/sql_select.cc:634\r\n#16 0x00005f295fca1611 in execute_sqlcom_select (thd=0x73579c000d58, all_tables=0x73579c01a578) at /test/12.2_dbg/sql/sql_parse.cc:6167\r\n#17 0x00005f295fc9639e in mysql_execute_command (thd=0x73579c000d58, is_called_from_prepared_stmt=false) at /test/12.2_dbg/sql/sql_parse.cc:3950\r\n#18 0x00005f295fc8e664 in mysql_parse (thd=0x73579c000d58, rawbuf=0x73579c019e80 \"SELECT * FROM t GROUP BY a WITH ROLLUP\", length=38, parser_state=0x7376802c2a10) at /test/12.2_dbg/sql/sql_parse.cc:7883\r\n#19 0x00005f295fc8ba38 in dispatch_command (command=COM_QUERY, thd=0x73579c000d58, packet=0x73579c00b1f9 \"SELECT * FROM t GROUP BY a WITH ROLLUP\", packet_length=38, blocking=true) at /test/12.2_dbg/sql/sql_parse.cc:1878\r\n#20 0x00005f295fc8f213 in do_command (thd=0x73579c000d58, blocking=true)at /test/12.2_dbg/sql/sql_parse.cc:1417\r\n#21 0x00005f295fe7c4b9 in do_handle_one_connection (connect=0x5f2996f21b58, put_in_cache=true) at /test/12.2_dbg/sql/sql_connect.cc:1414\r\n#22 0x00005f295fe7c25e in handle_one_connection (arg=0x5f2996e4d538)at /test/12.2_dbg/sql/sql_connect.cc:1326\r\n#23 0x000073768b49caa4 in start_thread (arg=<optimized out>)at ./nptl/pthread_create.c:447\r\n#24 0x000073768b529c3c in clone3 ()at ../sysdeps/unix/sysv/linux/x86_64/clone3.S:78\r\n{noformat}\r\n{noformat:title=Bug Detection Matrix}\r\n    Rel    o/d  Build   Commit                                    UniqueID observed             \r\nCS  10.6   dbg  080825  13f337ce1f295f4aac75db681e00c71f2bf8acaf  No bug found                  \r\nCS  10.6   opt  080825  13f337ce1f295f4aac75db681e00c71f2bf8acaf  No bug found                  \r\nCS  10.11  dbg  080825  c45a34b2fb10e4e8f768e7e5fe846e9592eb6ea8  No bug found                  \r\nCS  10.11  opt  080825  c45a34b2fb10e4e8f768e7e5fe846e9592eb6ea8  No bug found                  \r\nCS  11.4   dbg  080825  03b31c0bd99390c1984f19a19f22dd6e77b7692e  No bug found                  \r\nCS  11.4   opt  080825  03b31c0bd99390c1984f19a19f22dd6e77b7692e  No bug found                  \r\nCS  11.8   dbg  080825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  11.8   opt  080825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  12.0   dbg  080825  aab83aecdca15738d114cf5a2f223f1d12e4e6bd  No bug found                  \r\nCS  12.0   opt  080825  aab83aecdca15738d114cf5a2f223f1d12e4e6bd  No bug found                  \r\nCS  12.1   dbg  080825  033471a367b4c60b7262e64f43f46b02e95b9d74  n < m_size|SIGABRT|Bounds_checked_array<Item*>::operator[]|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info\r\nCS  12.1   opt  080825  033471a367b4c60b7262e64f43f46b02e95b9d74  SIGSEGV|base_list_iterator::replace|List_iterator<Item>::replace|JOIN::rollup_make_fields|JOIN::make_sum_func_list\r\nCS  12.2   dbg  080825  e02f4d7e311e214ea62ff2e59599849e229f4165  n < m_size|SIGABRT|Bounds_checked_array<Item*>::operator[]|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info\r\nCS  12.2   opt  080825  e02f4d7e311e214ea62ff2e59599849e229f4165  SIGSEGV|base_list_iterator::replace|List_iterator<Item>::replace|JOIN::rollup_make_fields|JOIN::make_sum_func_list\r\nES  10.5   dbg  080825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.5   opt  080825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.6   dbg  080825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  10.6   opt  080825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  11.4   dbg  080825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\nES  11.4   opt  080825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\nES  11.8   dbg  080825  4cdf75ab6ba37d4e7e208690785e880ed3176f2f  No bug found                  \r\nES  11.8   opt  080825  4cdf75ab6ba37d4e7e208690785e880ed3176f2f  No bug found                  \r\nMS  5.5    dbg  070123  bac287c315b1792e7ae33f91add6a60292f9bae8  No bug found                  \r\nMS  5.5    opt  070123  bac287c315b1792e7ae33f91add6a60292f9bae8  No bug found                  \r\nMS  5.6    dbg  070123  dab95781a1244104d6b87020ac2fc4d190ba2946  No bug found                  \r\nMS  5.6    opt  070123  dab95781a1244104d6b87020ac2fc4d190ba2946  No bug found                  \r\nMS  5.7    dbg  070525  f7680e98b6bbe3500399fbad465d08a6b75d7a5c  No bug found                  \r\nMS  5.7    opt  070525  f7680e98b6bbe3500399fbad465d08a6b75d7a5c  No bug found                  \r\nMS  8.0    dbg  060224  49ef33f7edadef3ae04665e73d1babd40179a4f1  No bug found                  \r\nMS  8.0    opt  060224  49ef33f7edadef3ae04665e73d1babd40179a4f1  No bug found                  \r\nMS  9.1    dbg  211024  61a3a1d8ef15512396b4c2af46e922a19bf2b174  No bug found                  \r\nMS  9.1    opt  211024  61a3a1d8ef15512396b4c2af46e922a19bf2b174  No bug found                  \r\n{noformat}\r\n\r\nThe assertion happens after this commit \r\n{noformat}\r\ncommit 8cdee25952763a0401e4c2a4d61e92c13499bdc6\r\nAuthor: Yuchen Pei <ycp@mariadb.com>\r\nDate:   Wed Jun 4 11:43:30 2025 +1000\r\n\r\n    MDEV-36132 Substitute vcol expressions with indexed vcol fields in ORDER BY and GROUP BY\r\n    \r\n    Also expand vcol field index coverings to include indexes covering all\r\n    the fields in the expression. The reasoning goes as follows: let f(c1,\r\n    c2, ..., cn) be a function on applied to columns c1, c2, ..., cn, if\r\n    f(...) is covered by an index, so should vc whose expression is\r\n    f(...).\r\n[..]\r\n{noformat}\r\n    ","comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/310668","id":"310668","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Roel","name":"Roel","key":"roel","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=roel&avatarId=27101","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=roel&avatarId=27101","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=roel&avatarId=27101","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=roel&avatarId=27101"},"displayName":"Roel Van de Paar","active":true,"timeZone":"Australia/Sydney"},"body":"ASAN sees a memory corruption:\r\n{code:sql}\r\nCREATE TABLE t (a INT,b INT,a1 INT GENERATED ALWAYS AS (a) VIRTUAL,INDEX (a1)) ENGINE=INNODB;\r\nSELECT * FROM t GROUP BY a WITH ROLLUP;\r\n{code}\r\n\r\nLeads to:\r\n\r\n{noformat:title=CS 12.1.2 033471a367b4c60b7262e64f43f46b02e95b9d74 (Optimized, UBASAN, Clang) Build 08/08/2025}\r\n==227602==ERROR: AddressSanitizer: use-after-poison on address 0x52d00016acd0 at pc 0x604d76fd71aa bp 0x7d913a0ffd00 sp 0x7d913a0ffcf8\r\nWRITE of size 8 at 0x52d00016acd0 thread T12\r\n    #0 0x604d76fd71a9 in JOIN::rollup_make_fields(List<Item>&, List<Item>&, Item_sum***) /test/12.1_opt_san/sql/sql_select.cc:30537:36\r\n    #1 0x604d76ebb4f6 in JOIN::make_sum_func_list(List<Item>&, List<Item>&, bool) /test/12.1_opt_san/sql/sql_select.cc:29689:9\r\n    #2 0x604d76f0491d in JOIN::make_aggr_tables_info() /test/12.1_opt_san/sql/sql_select.cc:4193:9\r\n    #3 0x604d76ec48a2 in JOIN::optimize_stage2() /test/12.1_opt_san/sql/sql_select.cc:3538:7\r\n    #4 0x604d76ecbfe1 in JOIN::optimize_inner() /test/12.1_opt_san/sql/sql_select.cc:2769:9\r\n    #5 0x604d76ebdf28 in JOIN::optimize() /test/12.1_opt_san/sql/sql_select.cc:2023:10\r\n    #6 0x604d76e9f317 in mysql_select(THD*, TABLE_LIST*, List<Item>&, Item*, unsigned int, st_order*, st_order*, Item*, st_order*, unsigned long long, select_result*, st_select_lex_unit*, st_select_lex*) /test/12.1_opt_san/sql/sql_select.cc:5388:19\r\n    #7 0x604d76e9dd00 in handle_select(THD*, LEX*, select_result*, unsigned long long) /test/12.1_opt_san/sql/sql_select.cc:634:10\r\n    #8 0x604d76d7b3a7 in execute_sqlcom_select(THD*, TABLE_LIST*) /test/12.1_opt_san/sql/sql_parse.cc:6167:12\r\n    #9 0x604d76d5c200 in mysql_execute_command(THD*, bool) /test/12.1_opt_san/sql/sql_parse.cc:3950:12\r\n    #10 0x604d76d3e230 in mysql_parse(THD*, char*, unsigned int, Parser_state*) /test/12.1_opt_san/sql/sql_parse.cc:7883:18\r\n    #11 0x604d76d35586 in dispatch_command(enum_server_command, THD*, char*, unsigned int, bool) /test/12.1_opt_san/sql/sql_parse.cc:1878:7\r\n    #12 0x604d76d404f6 in do_command(THD*, bool) /test/12.1_opt_san/sql/sql_parse.cc:1417:17\r\n    #13 0x604d7749907c in do_handle_one_connection(CONNECT*, bool) /test/12.1_opt_san/sql/sql_connect.cc:1414:11\r\n    #14 0x604d774988d6 in handle_one_connection /test/12.1_opt_san/sql/sql_connect.cc:1326:5\r\n    #15 0x604d75bf491c in asan_thread_start(void*) crtstuff.c\r\n    #16 0x7d9227a9ca93 in start_thread nptl/pthread_create.c:447:8\r\n    #17 0x7d9227b29c3b in clone3 misc/../sysdeps/unix/sysv/linux/x86_64/clone3.S:78\r\n\r\n0x52d00016acd0 is located 10448 bytes inside of 32760-byte region [0x52d000168400,0x52d0001703f8)\r\nallocated by thread T12 here:\r\n    #0 0x604d75bf6e33 in malloc (/test/UBASAN_MD080825-mariadb-12.1.2-linux-x86_64-opt/bin/mariadbd+0x28dde33) (BuildId: 7c59e07f91306529)\r\n    #1 0x604d78830fa2 in my_malloc /test/12.1_opt_san/mysys/my_malloc.c:93:29\r\n    #2 0x604d7880cbb3 in reset_root_defaults /test/12.1_opt_san/mysys/my_alloc.c:247:30\r\n    #3 0x604d7691fc64 in THD::init_for_queries() /test/12.1_opt_san/sql/sql_class.cc:1528:3\r\n    #4 0x604d774978b0 in prepare_new_connection_state(THD*) /test/12.1_opt_san/sql/sql_connect.cc:1252:8\r\n    #5 0x604d7749b119 in thd_prepare_connection(THD*) /test/12.1_opt_san/sql/sql_connect.cc:1347:3\r\n    #6 0x604d77499061 in do_handle_one_connection(CONNECT*, bool) /test/12.1_opt_san/sql/sql_connect.cc:1404:9\r\n    #7 0x604d774988d6 in handle_one_connection /test/12.1_opt_san/sql/sql_connect.cc:1326:5\r\n    #8 0x604d75bf491c in asan_thread_start(void*) crtstuff.c\r\n\r\nThread T12 created by T0 here:\r\n    #0 0x604d75bdc7a5 in pthread_create (/test/UBASAN_MD080825-mariadb-12.1.2-linux-x86_64-opt/bin/mariadbd+0x28c37a5) (BuildId: 7c59e07f91306529)\r\n    #1 0x604d75c47a11 in create_thread_to_handle_connection(CONNECT*) /test/12.1_opt_san/sql/mysqld.cc:6272:19\r\n    #2 0x604d75c48bfa in handle_connections_sockets() /test/12.1_opt_san/sql/mysqld.cc:6508:9\r\n    #3 0x604d75c46d60 in run_main_loop() /test/12.1_opt_san/sql/mysqld.cc:5750:3\r\n    #4 0x604d75c3e13b in mysqld_main(int, char**) /test/12.1_opt_san/sql/mysqld.cc:6173:3\r\n    #5 0x7d9227a2a1c9 in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16\r\n    #6 0x7d9227a2a28a in __libc_start_main csu/../csu/libc-start.c:360:3\r\n    #7 0x604d75b5bfe4 in _start (/test/UBASAN_MD080825-mariadb-12.1.2-linux-x86_64-opt/bin/mariadbd+0x2842fe4) (BuildId: 7c59e07f91306529)\r\n\r\nSUMMARY: AddressSanitizer: use-after-poison /test/12.1_opt_san/sql/sql_select.cc:30537:36 in JOIN::rollup_make_fields(List<Item>&, List<Item>&, Item_sum***)\r\nShadow bytes around the buggy address:\r\n  0x52d00016aa00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016aa80: 00 00 f7 05 f7 02 f7 03 f7 00 00 f7 00 00 00 00\r\n  0x52d00016ab00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016ab80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016ac00: 00 00 00 00 00 00 00 00 00 f7 00 00 f7 00 00 f7\r\n=>0x52d00016ac80: 00 00 f7 00 f7 00 00 00 00 00[f7]00 00 00 f7 00\r\n  0x52d00016ad00: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016ad80: f7 00 00 f7 00 00 f7 00 00 f7 00 00 00 f7 00 00\r\n  0x52d00016ae00: f7 00 00 f7 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016ae80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00\r\n  0x52d00016af00: 00 00 00 00 00 00 00 00 00 f7 00 00 f7 00 00 00\r\nShadow byte legend (one shadow byte represents 8 application bytes):\r\n  Addressable:           00\r\n  Partially addressable: 01 02 03 04 05 06 07 \r\n  Heap left redzone:       fa\r\n  Freed heap region:       fd\r\n  Stack left redzone:      f1\r\n  Stack mid redzone:       f2\r\n  Stack right redzone:     f3\r\n  Stack after return:      f5\r\n  Stack use after scope:   f8\r\n  Global redzone:          f9\r\n  Global init order:       f6\r\n  Poisoned by user:        f7\r\n  Container overflow:      fc\r\n  Array cookie:            ac\r\n  Intra object redzone:    bb\r\n  ASan internal:           fe\r\n  Left alloca redzone:     ca\r\n  Right alloca redzone:    cb\r\n==227602==ABORTING\r\n{noformat}\r\n\r\nSetup:\r\n\r\n{noformat}\r\nCompiled with a recent version of Clang and LLVM. Ubuntu instructions for Clang/LLVM 18:\r\n  # Note: It is strongly recommended to uninstall all old Clang & LLVM packages (ref  dpkg --list | grep -iE 'clang|llvm'  and use  apt purge  and  dpkg --purge  to remove the packages), before installing Clang/LLVM 18\r\n     sudo apt install clang llvm-18 llvm-18-linker-tools llvm-18-runtime llvm-18-tools llvm-18-dev libstdc++-14-dev llvm-dev\r\nCompiled with: \"-DCMAKE_C_COMPILER=/usr/bin/clang -DCMAKE_CXX_COMPILER=/usr/bin/clang++ -DCMAKE_C{,XX}_FLAGS='-march=native -mtune=native'\" and:\r\n    -DWITH_ASAN=ON -DWITH_ASAN_SCOPE=ON -DWITH_UBSAN=ON -DWSREP_LIB_WITH_ASAN=ON\r\nSet before execution:\r\n    export ASAN_OPTIONS=quarantine_size_mb=512:atexit=0:detect_invalid_pointer_pairs=3:dump_instruction_bytes=1:abort_on_error=1:allocator_may_return_null=1\r\n{noformat}\r\n\r\n{noformat:title=SAN Bug Detection Matrix}\r\n    Rel    o/d  Build   Commit                                    UniqueID observed             \r\nCS  10.6   dbg  080825  13f337ce1f295f4aac75db681e00c71f2bf8acaf  No bug found                  \r\nCS  10.6   opt  080825  13f337ce1f295f4aac75db681e00c71f2bf8acaf  No bug found                  \r\nCS  10.11  dbg  080825  c45a34b2fb10e4e8f768e7e5fe846e9592eb6ea8  No bug found                  \r\nCS  10.11  opt  080825  c45a34b2fb10e4e8f768e7e5fe846e9592eb6ea8  No bug found                  \r\nCS  11.4   dbg  080825  03b31c0bd99390c1984f19a19f22dd6e77b7692e  No bug found                  \r\nCS  11.4   opt  080825  03b31c0bd99390c1984f19a19f22dd6e77b7692e  No bug found                  \r\nCS  11.8   dbg  080825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  11.8   opt  080825  1a446ccc48528e88a3cd6cd1d1ec9e7492d342ca  No bug found                  \r\nCS  12.0   dbg  080825  aab83aecdca15738d114cf5a2f223f1d12e4e6bd  No bug found                  \r\nCS  12.0   opt  080825  aab83aecdca15738d114cf5a2f223f1d12e4e6bd  No bug found                  \r\nCS  12.1   dbg  080825  033471a367b4c60b7262e64f43f46b02e95b9d74  n < m_size|SIGABRT|Bounds_checked_array<Item*>::operator[]|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info\r\nCS  12.1   opt  080825  033471a367b4c60b7262e64f43f46b02e95b9d74  ASAN|use-after-poison|sql/sql_select.cc|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info|JOIN::optimize_stage2\r\nCS  12.2   dbg  080825  e02f4d7e311e214ea62ff2e59599849e229f4165  n < m_size|SIGABRT|Bounds_checked_array<Item*>::operator[]|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info\r\nCS  12.2   opt  080825  e02f4d7e311e214ea62ff2e59599849e229f4165  ASAN|use-after-poison|sql/sql_select.cc|JOIN::rollup_make_fields|JOIN::make_sum_func_list|JOIN::make_aggr_tables_info|JOIN::optimize_stage2\r\nES  10.5   dbg  080825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.5   opt  080825  70586522eacf09d04d49962072e14325a75d8155  No bug found                  \r\nES  10.6   dbg  080825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  10.6   opt  080825  9b794f34b48fb7eee490b6da44edc0f33a947447  No bug found                  \r\nES  11.4   dbg  080825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\nES  11.4   opt  080825  a1c03ccd54b582e75506687ee19b273ca897f261  No bug found                  \r\nES  11.8   dbg  090825  4cdf75ab6ba37d4e7e208690785e880ed3176f2f  No bug found                  \r\nES  11.8   opt  090825  4cdf75ab6ba37d4e7e208690785e880ed3176f2f  No bug found                  \r\n{noformat}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Roel","name":"Roel","key":"roel","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=roel&avatarId=27101","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=roel&avatarId=27101","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=roel&avatarId=27101","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=roel&avatarId=27101"},"displayName":"Roel Van de Paar","active":true,"timeZone":"Australia/Sydney"},"created":"2025-08-12T22:47:44.000+0000","updated":"2025-08-12T22:47:44.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/312555","id":"312555","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"During preparation, rollup.ref_pointer_array[0] is initialised with the same number of elements as all_fields\n\n{code:c++}\n/* in JOIN::rollup_init: */\n    rollup.ref_pointer_arrays[i]= Ref_ptr_array(ref_array, all_fields.elements);\n{code}\n\nIn optimization, feature MDEV-36132 adds the substituted ORDER BY/GROUP BY vcol index item to all_fields:\n\n{noformat}\n/* in subst_vcols_in_order: */\n      /*\n        If the old ORDER BY item is a SELECT item, then insert the new\n        item to all_fields and keep it in sync with ref_pointer_array.\n        Otherwise it is safe to replace the old item with the new item\n        in all_fields.\n      */\n      if (order->in_field_list)\n      {\n        uint el= join->all_fields.elements;\n        join->all_fields.push_front(new_item);\n        join->select_lex->ref_pointer_array[el]= new_item;\n        order->item= &join->select_lex->ref_pointer_array[el];\n        order->in_field_list= false;\n      }\n{noformat}\n\nFurther in opitimization (optimize_stage2), array-out-of-bound error happens as all_field, passed as fields_arg has more elements than rollup.ref_pointer_array[0] now:\n\n{code:c++}\n/* in JOIN::rollup_make_fields: */\n    Ref_ptr_array ref_array_start= rollup.ref_pointer_arrays[pos];\n    ORDER *start_group;\n\n    /* Point to first hidden field */\n    uint ref_array_ix= fields_arg.elements-1;\n//  [... 61 lines elided]\n      ref_array_start[ref_array_ix]= item;\n{code}\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-10T04:16:35.000+0000","updated":"2025-09-10T04:16:35.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/312868","id":"312868","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Why is the assertion not triggered with myisam?\n\nBecause myisam has exact row count which is 0, the table is marked as const\n{code:c++}\n// in make_join_statistics:\n    if (!table->is_filled_at_execution() &&\n        (table->s->system ||\n         (table->file->stats.records <= 1 &&\n          (table->file->ha_table_flags() & HA_STATS_RECORDS_IS_EXACT)) ||\n         all_partitions_pruned_away) &&\n\t!s->dependent &&\n        !table->fulltext_searched && !join->no_const_tables)\n    {\n      set_position(join,const_count++,s,(KEYUSE*) 0);\n      no_rows_const_tables |= table->map;\n    }\n{code}\nthen marked in join->const_table_map\n{code:c++}\n// in make_join_statistics:\n  /* Read tables with 0 or 1 rows (system tables) */\n  for (POSITION *p_pos=join->positions, *p_end=p_pos+const_count;\n       p_pos < p_end ;\n       p_pos++)\n  {\n//  [... 5 lines elided]\n      join->const_table_map|=s->table->map;\n//  [... 11 lines elided]\n  }\n{code}\nwhich causes an early exit (skipping JOIN::make_aggr_tables_info) due to empty results:\n{code:c++}\n// in JOIN::optimize_stage2:\n  if (const_table_map != found_const_table_map &&\n      !(select_options & SELECT_DESCRIBE))\n  {\n    // There is at least one empty const table\n    zero_result_cause= \"no matching row in const table\";\n//  [... 3 lines elided]\n    goto setup_subq_exit;\n  }\n{code}\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-15T06:32:23.000+0000","updated":"2025-09-15T06:32:23.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/313062","id":"313062","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"The method JOIN::rollup_make_fields constructs the \"rollup version\" of all_fields / the fields_arg argument (rollup.ref_pointer_arrays) and fields_list / the sel_fields argument (rollup.fields).\n\nSuppose\n\n{noformat}\nfields_arg == {c1, c2, ..., cn, d1, d2, ..., dm}\nsel_fields == {d1, d2, ..., dm}\n{noformat}\n\nThen\n\n{noformat}\nrollup.ref_pointer_arrays[pos] == {d1-or-NULL, d2-or-NULL, ..., dm-or-NULL, cn-or-NULL, ..., c2-or-NULL, c1-or-NULL}\nrollup.fields[pos] == {d1-or-NULL, d2-or-NULL, ..., dm-or-NULL}\n{noformat}\n\nwhere an x-or-NULL is NULL if x is in the pos-level of the \"rollup GROUP list\".\n\nBelow are two examples lifted from the test main.group_by.\n\nFirst, consider\n\nselect distinct 1 from t1 group by a,b with rollup limit 1\n\nwe have\n\n{noformat}\nfields_arg == {b, a, 1}\nsel_fields == {1}\nlevel-0 group list == {a, b}\nrollup.ref_pointer_arrays[0] == {1, NULL, NULL}\nrollup.fields[0] == {1}\nlevel-1 group list == {b}\nrollup.ref_pointer_arrays[1] == {1, a, NULL}\nrollup.fields[1] == {1}\n{noformat}\n\nNow consider\n\nSELECT d != '2023-03-04' AS f, COUNT(*) FROM t1 GROUP BY d WITH ROLLUP\n\nwe have\n\n{noformat}\nfields_arg == {d, d <> '2023-03-04', count(*)}\nsel_fields == {d <> '2023-03-04', count(*)}\nlevel-0 group list == {d}\nrollup.ref_pointer_arrays[0] == {d <> '2023-03-04', count(*), NULL}\nrollup.fields[0] == {d <> '2023-03-04', count(*)}\n{noformat}\n\nIn our example\n\nSELECT a, b, a1 FROM t GROUP BY a WITH ROLLUP;\n\nAfter the GROUP BY substitution of a by a1, the a1 is prepended to the all_fields / fields_arg list:\n\n{noformat}\nfields_arg == {a1, a, b, a1}\nsel_fields == {a, b, a1}\nlevel-0 group list == {a1}\n{noformat}\n\nFirst question is, should we not push an extra a1 to the front of the all_fields list? If we didn't because there's already an a1 in the list, then JOIN::rollup_make_fields should be able to handle it as if the query was\n\nSELECT a, b, a1 FROM t GROUP BY a1 WITH ROLLUP;\n\n{noformat}\nfields_arg == {a, b, a1}\nsel_fields == {a, b, a1}\nlevel-0 group list == {a1}\nrollup.ref_pointer_arrays[0] == {a, b, NULL}\nrollup.fields[0] == {a, b, NULL}\n{noformat}\n\nIf we do de-duplicate in this case, then another question arises: should the Item_field a1 that substituted a be the same as the existing Item_field a1 in all_fields, or should it be a new item as it is now?\n\nWe also need to consider the example where there are hidden fields, such as\n\nselect a, b from t group by a with rollup;\n\nHere when the GROUP BY a is replaced with a1, and the a1 is pushed to the front of all_fields, we should have\n\n{noformat}\nfields_arg == {a1, a, b}\nsel_fields == {a, b}\nlevel-0 group list == {a1}\nrollup.ref_pointer_arrays[0] == {a, b, NULL}\nrollup.fields[0] == {a, b}\n{noformat}\n\nIn this case, a1 has to be pushed to all_fields because there's no existing a1. As far as JOIN::rollup_make_fields is concerned it is equivalent to\n\nselect a, b from t group by a1 with rollup;\n\nAnd given the length change of all_fields it seems we have to change the length of rollup.ref_pointer_arrays[0] too.\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-17T04:35:26.000+0000","updated":"2025-09-17T04:35:26.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/313068","id":"313068","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"> If we do de-duplicate in this case, then another question arises: should the Item_field a1 that substituted a be the same as the existing Item_field a1 in all_fields, or should it be a new item as it is now?\n\nIf we do the latter, i.e. create a new vcol Item_field for GROUP BY, but choose not to add it to all_fields because a Item_field of the same vcol is already in there, we will trip the same assertion failure that was the reason to push to all_fields in the first place (see also https://jira.mariadb.org/browse/MDEV-36132?focusedCommentId=305793&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-305793):\n\n{code:c++}\n// in Create_tmp_table::finalize:\n    ORDER *cur_group= m_group;\n    for (; cur_group ; cur_group= cur_group->next, m_key_part_info++)\n    {\n      Field *field=(*cur_group->item)->get_tmp_table_field();\n      DBUG_ASSERT(field->table == table);\n{code}\n\nThis happens at the following example because the GROUP BY item is subst'd with a new vc which is not in all_fields\n\n{code:sql}\ncreate table t (c int, key (c));\nalter table t\n  add column vc int as (c + 1),\n  add index(vc);\nselect vc from t group by c + 1;\n{code}\n\nSee bb-12.1-mdev-37422-dedup-1 28ad2f2ac8d0f96fd56e2c5abda4d25edeedc656 for the patch.\n\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-17T06:37:44.000+0000","updated":"2025-09-17T06:37:44.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/313070","id":"313070","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Or maybe we could simply re-init the rollup like so?\r\n\r\n{code:diff}\r\nmodified   sql/opt_vcol_substitution.cc\r\n@@ -307,6 +307,9 @@ bool substitute_indexed_vcols_for_join(JOIN *join)\r\n     count_field_types(join->select_lex, &join->tmp_table_param,\r\n                       join->all_fields, 0);\r\n     join->select_lex->update_used_tables();\r\n+    if (join->rollup.state != st_rollup::STATE_NONE &&\r\n+        join->all_fields.elements != join->rollup.ref_pointer_arrays[0].size())\r\n+      join->rollup_init();\r\n   }\r\n \r\n   if (join->thd->is_error())\r\n\r\n{code}\r\n\r\npushed as \r\n\r\ndd8295d3694 bb-12.1-mdev-37422-reinit-rollup MDEV-37422 [wip] reinit rollup","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-17T07:00:19.000+0000","updated":"2025-09-17T07:34:49.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/313078","id":"313078","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Looks close...\n\nIf we mtr --record the following testcase at 11.8\n\n{code:sql}\n--source include/have_innodb.inc\n--source include/have_sequence.inc\n\nCREATE TABLE t (a INT,b INT,a1 INT GENERATED ALWAYS AS (a) VIRTUAL,INDEX (a1)) ENGINE=INNODB;\ninsert into t (a, b) select seq / 10, seq from seq_1_to_100;\nSELECT * FROM t GROUP BY a WITH ROLLUP;\nSELECT a, b FROM t GROUP BY a WITH ROLLUP;\nSELECT a, count(b) FROM t GROUP BY a WITH ROLLUP;\nSELECT count(b) FROM t GROUP BY a WITH ROLLUP;\ndrop table t;\n{code}\n\nThen run it at 12.1 base, surprisingly there's no crash as in empty table. But the results are wrong:\n\n{code:diff}\ntemp.mdev_37422                          [ fail ]\n        Test ended at 2025-09-17 17:37:54\n\nCURRENT_TEST: temp.mdev_37422\n--- /home/ycp/source/mariadb-server/12.1/src/mysql-test/suite/temp/r/mdev_37422.result\t2025-09-17 17:37:28.076730493 +1000\n+++ /home/ycp/source/mariadb-server/12.1/src/mysql-test/suite/temp/r/mdev_37422.reject\t2025-09-17 17:37:53.880444366 +1000\n@@ -3,31 +3,29 @@\n SELECT * FROM t GROUP BY a WITH ROLLUP;\n a\tb\ta1\n 0\t1\t0\n-1\t14\t1\n-2\t21\t2\n-3\t31\t3\n-4\t41\t4\n-5\t51\t5\n-6\t61\t6\n-7\t71\t7\n-8\t81\t8\n-9\t91\t9\n-10\t99\t10\n-NULL\t99\t10\n+1\t5\t1\n+2\t15\t2\n+3\t25\t3\n+4\t35\t4\n+5\t45\t5\n+6\t55\t6\n+7\t65\t7\n+8\t75\t8\n+9\t85\t9\n+10\t95\t10\n SELECT a, b FROM t GROUP BY a WITH ROLLUP;\n a\tb\n 0\t1\n-1\t14\n-2\t21\n-3\t31\n-4\t41\n-5\t51\n-6\t61\n-7\t71\n-8\t81\n-9\t91\n-10\t99\n-NULL\t99\n+1\t5\n+2\t15\n+3\t25\n+4\t35\n+5\t45\n+6\t55\n+7\t65\n+8\t75\n+9\t85\n+10\t95\n SELECT a, count(b) FROM t GROUP BY a WITH ROLLUP;\n a\tcount(b)\n 0\t4\n@@ -41,5 +39,4 @@\n 8\t10\n 9\t10\n 10\t6\n-NULL\t100\n SELECT count(b) FROM t GROUP BY a WITH ROLLUP;\n count(b)\n 4\n@@ -55,5 +52,4 @@\n 10\n 10\n 6\n-100\n drop table t;\n\nResult length mismatch\n{code}\n\nBut at the ReinitRollup patch, it is less wrong:\n\n{code:diff}\ntemp.mdev_37422                          [ fail ]\n        Test ended at 2025-09-17 17:40:49\n\nCURRENT_TEST: temp.mdev_37422\n--- /home/ycp/source/mariadb-server/12.1/src/mysql-test/suite/temp/r/mdev_37422.result\t2025-09-17 17:37:28.076730493 +1000\n+++ /home/ycp/source/mariadb-server/12.1/src/mysql-test/suite/temp/r/mdev_37422.reject\t2025-09-17 17:40:49.126538611 +1000\n@@ -13,7 +13,7 @@\n 8\t81\t8\n 9\t91\t9\n 10\t99\t10\n-NULL\t99\t10\n+10\t99\t10\n SELECT a, b FROM t GROUP BY a WITH ROLLUP;\n a\tb\n 0\t1\n@@ -27,7 +27,7 @@\n 8\t81\n 9\t91\n 10\t99\n-NULL\t99\n+10\t99\n SELECT a, count(b) FROM t GROUP BY a WITH ROLLUP;\n a\tcount(b)\n 0\t4\n@@ -41,5 +41,5 @@\n 8\t10\n 9\t10\n 10\t6\n-NULL\t100\n+10\t100\n SELECT count(b) FROM t GROUP BY a WITH ROLLUP;\n count(b)\n 4\n@@ -55,5 +55,4 @@\n 10\n 10\n 6\n-100\n drop table t;\n\nResult length mismatch\n{code}","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-17T07:41:26.000+0000","updated":"2025-09-17T08:01:53.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/313452","id":"313452","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"body":"Hi [~psergei], ptal at the top two commits thanks:\r\n\r\n{noformat}\r\n45e35f2745a upstream/bb-12.1-mdev-37422 MDEV-37422 Reinit rollup on GROUP BY vcol index substitution\r\na650d712887 remove SELECT_CHECK\r\n8a8d2f79dec MDEV-37682 Check equality of items rather than pointers in rollup_make_fields\r\n{noformat}\r\n\r\nThe bottom commit is the same patch as the one under review for MDEV-37682. I include it above to emphasise that this patch is based on that patch. The middle patch is a cleanup that should be pushed to lowest possible branch higher than 10.6. The top commit is the main patch for this bug.\r\n\r\nBelow the bottom commit is the patch for MDEV-37435 currently under review. I have that as the base because both this bug and MDEV-37435 are caused by the same feature.\r\n\r\nAn alternative fix would be disabling GROUP BY vcol index substitution when the query has WITH ROLLUP. It could serve as a fallback if there are problems with the approach in this patch.","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=ycp","name":"ycp","key":"JIRAUSER52627","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=JIRAUSER52627&avatarId=25924","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=JIRAUSER52627&avatarId=25924","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=JIRAUSER52627&avatarId=25924","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=JIRAUSER52627&avatarId=25924"},"displayName":"Yuchen Pei","active":true,"timeZone":"Australia/Melbourne"},"created":"2025-09-23T03:06:02.000+0000","updated":"2025-09-23T03:09:15.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/317192","id":"317192","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Implemented alternative fix, addressed [~ycp]'s input: \r\n\r\n{code}\r\ncommit aac76d5a6940343a8ec6aad8145a3b56c15054b6 (HEAD -> bb-12.1-mdev-37422-v3, origin/bb-12.1-mdev-37422-v3)\r\nAuthor: Sergei Petrunia <sergey@mariadb.com>\r\nDate:   Wed Nov 12 11:52:54 2025 +0200\r\n\r\n    MDEV-37422: SIGSEGV / Assert for vcol substitution in GROUP BY WITH ROLLUP\r\n    \r\n    Variant 2:\r\n    Do not do virtual column substitution in GROUP BY when WITH ROLLUP is\r\n    present.\r\n    \r\n    Approved by: Yuchen Pei <ycp@mariadb.com>\r\n\r\n{code}\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-12T11:06:46.000+0000","updated":"2025-11-12T11:06:46.000+0000"},{"self":"https://jira.mariadb.org/rest/api/2/issue/135944/comment/317287","id":"317287","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"body":"Got Ok to push for the Variant 2 push from Yuchen (so marked as Approved).\r\n\r\nWill file another MDEV to cover the original approach taken by Yuchen's fix.\r\n\r\nThis one is waiting to be pushed when the tree is unlocked\r\n\r\n","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=psergei","name":"psergei","key":"psergey","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=psergey&avatarId=10200","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=psergey&avatarId=10200","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=psergey&avatarId=10200","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=psergey&avatarId=10200"},"displayName":"Sergei Petrunia","active":true,"timeZone":"Europe/Helsinki"},"created":"2025-11-13T13:06:43.000+0000","updated":"2025-11-13T13:06:43.000+0000"}],"maxResults":10,"total":10,"startAt":0}}}]}